"use strict";(self.webpackChunk_wiki3ai_lite_kernel=self.webpackChunk_wiki3ai_lite_kernel||[]).push([[808],{808:(e,t,n)=>{var o,r=Object.defineProperty,s=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyNames,a=Object.prototype.hasOwnProperty,l={};((e,t)=>{for(var n in t)r(e,n,{get:t[n],enumerable:!0})})(l,{WebLLMLanguageModel:()=>R,WebWorkerMLCEngineHandler:()=>D.WebWorkerMLCEngineHandler,doesBrowserSupportWebLLM:()=>j,webLLM:()=>J}),e.exports=(o=l,((e,t,n,o)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let n of i(t))a.call(e,n)||undefined===n||r(e,n,{get:()=>t[n],enumerable:!(o=s(t,n))||o.enumerable});return e})(r({},"__esModule",{value:!0}),o));var c,u="vercel.ai.error",f=Symbol.for(u),h=class e extends Error{constructor({name:e,message:t,cause:n}){super(t),this[c]=!0,this.name=e,this.cause=n}static isInstance(t){return e.hasMarker(t,u)}static hasMarker(e,t){const n=Symbol.for(t);return null!=e&&"object"==typeof e&&n in e&&"boolean"==typeof e[n]&&!0===e[n]}};c=f;var p=h;Symbol.for("vercel.ai.error.AI_APICallError"),Symbol.for("vercel.ai.error.AI_EmptyResponseBodyError"),Symbol.for("vercel.ai.error.AI_InvalidArgumentError"),Symbol.for("vercel.ai.error.AI_InvalidPromptError"),Symbol.for("vercel.ai.error.AI_InvalidResponseDataError"),Symbol.for("vercel.ai.error.AI_JSONParseError"),Symbol.for("vercel.ai.error.AI_LoadAPIKeyError");var m,g="AI_LoadSettingError",d=`vercel.ai.error.${g}`,b=Symbol.for(d),y=class extends p{constructor({message:e}){super({name:g,message:e}),this[m]=!0}static isInstance(e){return p.hasMarker(e,d)}};m=b,Symbol.for("vercel.ai.error.AI_NoContentGeneratedError"),Symbol.for("vercel.ai.error.AI_NoSuchModelError"),Symbol.for("vercel.ai.error.AI_TooManyEmbeddingValuesForCallError"),Symbol.for("vercel.ai.error.AI_TypeValidationError");var S,v="AI_UnsupportedFunctionalityError",E=`vercel.ai.error.${v}`,_=Symbol.for(E),C=class extends p{constructor({functionality:e,message:t=`'${e}' functionality not supported.`}){super({name:v,message:t}),this[S]=!0,this.functionality=e}static isInstance(e){return p.hasMarker(e,E)}};function w(e,t,n){if(!t||0===t.length)return e||"";const o=t.map(e=>{const t=function(e){return"parameters"in e?e.parameters:e.inputSchema}(e);return{name:e.name,description:e.description??"No description provided.",parameters:t||{type:"object",properties:{}}}}),r=`You are a helpful AI assistant with access to tools.\n\n# Available Tools\n${JSON.stringify(o,null,2)}\n\n# Tool Calling Instructions\nOnly request one tool call at a time. Wait for tool results before asking for another tool.\n\nTo call a tool, output JSON in this exact format inside a \`\`\`tool_call code fence:\n\n\`\`\`tool_call\n{"name": "tool_name", "arguments": {"param1": "value1", "param2": "value2"}}\n\`\`\`\n\nTool responses will be provided in \`\`\`tool_result fences. Each line contains JSON like:\n\`\`\`tool_result\n{"id": "call_123", "name": "tool_name", "result": {...}, "error": false}\n\`\`\`\nUse the \`result\` payload (and treat \`error\` as a boolean flag) when continuing the conversation.\n\nImportant:\n- Use exact tool and parameter names from the schema above\n- Arguments must be a valid JSON object matching the tool's parameters\n- You can include brief reasoning before or after the tool call\n- If no tool is needed, respond directly without tool_call fences`;return e?.trim()?`${e.trim()}\n\n${r}`:r}S=_;var x=/```tool[_-]?call\s*([\s\S]*?)```/gi;function F(){return`call_${Date.now()}_${Math.random().toString(36).slice(2,9)}`}function k(e){const t=Array.from(e.matchAll(x));if(x.lastIndex=0,0===t.length)return{toolCalls:[],textContent:e};const n=[];let o=e;for(const e of t){const[t,r]=e;o=o.replace(t,"");try{const e=r.trim();try{const t=JSON.parse(e),o=Array.isArray(t)?t:[t];for(const e of o)e.name&&n.push({type:"tool-call",toolCallId:e.id||F(),toolName:e.name,args:e.arguments||{}})}catch{const t=e.split("\n").filter(e=>e.trim());for(const e of t)try{const t=JSON.parse(e.trim());if(!t.name)continue;n.push({type:"tool-call",toolCallId:t.id||F(),toolName:t.name,args:t.arguments||{}})}catch{continue}}}catch(e){console.warn("Failed to parse JSON tool call:",e);continue}}return o=o.replace(/\n{2,}/g,"\n"),{toolCalls:n,textContent:o.trim()}}function I(e){return 0===e.length?"":`\`\`\`tool_result\n${e.map(e=>function(e){return JSON.stringify({id:e.toolCallId,name:e.toolName,result:e.result,error:e.isError??!1})}(e)).join("\n")}\n\`\`\``}function N(e){const{value:t,isError:n}=function(e){switch(e.type){case"text":case"json":case"content":return{value:e.value,isError:!1};case"error-text":case"error-json":return{value:e.value,isError:!0};default:return{value:e,isError:!1}}}(e.output);return{toolCallId:e.toolCallId,toolName:e.toolName,result:t,isError:n}}function A(e){const t=Array.from(e,e=>String.fromCharCode(e)).join("");return btoa(t)}function T(e,t){if(e instanceof URL)return e.toString();if("string"==typeof e)return`data:${t};base64,${e}`;if(e instanceof Uint8Array)return`data:${t};base64,${A(e)}`;if(e instanceof ArrayBuffer)return`data:${t};base64,${A(new Uint8Array(e))}`;if("undefined"!=typeof Buffer&&e instanceof Buffer)return`data:${t};base64,${e.toString("base64")}`;throw new C({functionality:"file data type: "+typeof e})}var L=n(567);function O(e,t){return{type:"unsupported-setting",setting:e,details:t}}function q(e,t){return{type:"unsupported-tool",tool:e,details:t}}function M(e){return"function"===e.type}function P(e){const t=e.filter(e=>"system"===e.role),n=e.filter(e=>"system"!==e.role);return 0===t.length?{systemPrompt:void 0,messages:e}:{systemPrompt:t.map(e=>e.content).filter(e=>"string"==typeof e).join("\n\n")||void 0,messages:n}}function $(e,t){if(!t.trim())return e;const n=e.findIndex(e=>"system"===e.role);if(-1!==n){const o=[...e],r=e[n],s="string"==typeof r.content?r.content:"";return o[n]={...r,content:t+(s?`\n\n${s}`:"")},o}return[{role:"system",content:t},...e]}var W=class{constructor(){this.FENCE_STARTS=["```tool_call"],this.FENCE_END="```",this.buffer="",this.inFence=!1,this.fenceStartBuffer=""}addChunk(e){this.buffer+=e}getBuffer(){return this.buffer}clearBuffer(){this.buffer=""}detectFence(){const{index:e,prefix:t}=this.findFenceStart(this.buffer);if(-1===e){const e=this.computeOverlapLength(this.buffer,this.FENCE_STARTS),t=this.buffer.length-e,n=t>0?this.buffer.slice(0,t):"",o=e>0?this.buffer.slice(-e):"";return this.buffer=o,{fence:null,prefixText:n,remainingText:"",overlapLength:e}}const n=this.buffer.slice(0,e);this.buffer=this.buffer.slice(e);const o=t?.length??0,r=this.buffer.indexOf(this.FENCE_END,o);if(-1===r)return{fence:null,prefixText:n,remainingText:"",overlapLength:0};const s=r+this.FENCE_END.length,i=this.buffer.slice(0,s),a=this.buffer.slice(s);return this.buffer="",{fence:i,prefixText:n,remainingText:a,overlapLength:0}}findFenceStart(e){let t=-1,n=null;for(const o of this.FENCE_STARTS){const r=e.indexOf(o);-1!==r&&(-1===t||r<t)&&(t=r,n=o)}return{index:t,prefix:n}}computeOverlapLength(e,t){let n=0;for(const o of t)for(let t=Math.min(e.length,o.length-1);t>0;t-=1)if(o.startsWith(e.slice(-t))){n=Math.max(n,t);break}return n}hasContent(){return this.buffer.length>0}getBufferSize(){return this.buffer.length}detectStreamingFence(){if(!this.inFence){const{index:e,prefix:t}=this.findFenceStart(this.buffer);if(-1===e){const e=this.computeOverlapLength(this.buffer,this.FENCE_STARTS),t=this.buffer.length-e,n=t>0?this.buffer.slice(0,t):"";return this.buffer=this.buffer.slice(t),{inFence:!1,safeContent:n,completeFence:null,textAfterFence:""}}const n=this.buffer.slice(0,e),o=t?.length??0;return this.buffer=this.buffer.slice(e+o),this.buffer.startsWith("\n")&&(this.buffer=this.buffer.slice(1)),this.inFence=!0,this.fenceStartBuffer="",{inFence:!0,safeContent:n,completeFence:null,textAfterFence:""}}const e=this.buffer.indexOf(this.FENCE_END);if(-1===e){const e=this.computeOverlapLength(this.buffer,[this.FENCE_END]),t=this.buffer.length-e;if(t>0){const e=this.buffer.slice(0,t);return this.fenceStartBuffer+=e,this.buffer=this.buffer.slice(t),{inFence:!0,safeContent:e,completeFence:null,textAfterFence:""}}return{inFence:!0,safeContent:"",completeFence:null,textAfterFence:""}}const t=this.buffer.slice(0,e);this.fenceStartBuffer+=t;const n=`${this.FENCE_STARTS[0]}\n${this.fenceStartBuffer}\n${this.FENCE_END}`,o=this.buffer.slice(e+this.FENCE_END.length);return this.inFence=!1,this.fenceStartBuffer="",this.buffer=o,{inFence:!1,safeContent:t,completeFence:n,textAfterFence:o}}isInFence(){return this.inFence}resetStreamingState(){this.inFence=!1,this.fenceStartBuffer=""}};function j(){return void 0!==globalThis?.navigator?.gpu}function z(e){const t=e.match(/\{\s*"name"\s*:\s*"([^"]+)"/);return t?t[1]:null}function B(e){const t=e.match(/"arguments"\s*:\s*/);if(!t||void 0===t.index)return"";let n="",o=0,r=!1,s=!1,i=!1;for(let a=t.index+t[0].length;a<e.length;a++){const t=e[a];if(n+=t,i)if(s)s=!1;else if("\\"!==t)if('"'!==t){if(!r)if("{"===t||"["===t)o+=1;else if(("}"===t||"]"===t)&&o>0&&(o-=1,0===o))break}else r=!r;else s=!0;else/\s/.test(t)||(i=!0,"{"!==t&&"["!==t||(o=1))}return n}var R=class{constructor(e,t={}){this.specificationVersion="v2",this.provider="web-llm",this.isInitialized=!1,this.supportedUrls={},this.modelId=e,this.config={provider:this.provider,modelId:e,options:t}}get isModelInitialized(){return this.isInitialized}async getEngine(e,t){if("unavailable"===await this.availability())throw new y({message:"WebLLM is not available. This library requires a browser with WebGPU support."});if(this.engine&&this.isInitialized)return this.engine;if(this.initializationPromise&&(await this.initializationPromise,this.engine))return this.engine;if(this.initializationPromise=this._initializeEngine(e,t),await this.initializationPromise,!this.engine)throw new y({message:"Engine initialization failed"});return this.engine}async _initializeEngine(e,t){try{const n={...this.config.options.engineConfig,...e,initProgressCallback:t||this.config.options.initProgressCallback};this.config.options.worker?this.engine=await(0,L.CreateWebWorkerMLCEngine)(this.config.options.worker,this.modelId,n):(this.engine=new L.MLCEngine(n),await this.engine.reload(this.modelId)),this.isInitialized=!0}catch(e){throw this.engine=void 0,this.isInitialized=!1,this.initializationPromise=void 0,new y({message:`Failed to initialize WebLLM engine: ${e instanceof Error?e.message:"Unknown error"}`})}}getArgs({prompt:e,maxOutputTokens:t,temperature:n,topP:o,topK:r,frequencyPenalty:s,presencePenalty:i,stopSequences:a,responseFormat:l,seed:c,tools:u,toolChoice:f}){const h=[],p=(u??[]).filter(M).map(e=>({name:e.name,description:e.description,parameters:e.inputSchema})),m=(u??[]).filter(e=>!M(e));for(const e of m)h.push(q(e,"Only function tools are supported by WebLLM"));null!=r&&h.push(O("topK","topK is not supported by WebLLM")),null!=a&&h.push(O("stopSequences","Stop sequences may not be fully implemented")),null!=i&&h.push(O("presencePenalty","Presence penalty is not fully implemented")),null!=s&&h.push(O("frequencyPenalty","Frequency penalty is not fully implemented")),null!=f&&h.push(O("toolChoice","toolChoice is not supported by WebLLM"));const g=function(e){const t=[];for(const n of e)switch(n.role){case"system":t.push({role:"system",content:n.content});break;case"user":if(!n.content.some(e=>"file"===e.type)){const e=[];for(const t of n.content)"text"===t.type&&e.push(t.text);t.push({role:"user",content:e.join("\n")});break}const e=[];for(const t of n.content)if("text"===t.type)e.push({type:"text",text:t.text});else if("file"===t.type){if(!t.mediaType?.startsWith("image/"))throw new C({functionality:`file input with media type '${t.mediaType}'`});e.push({type:"image_url",image_url:{url:T(t.data,t.mediaType)}})}t.push({role:"user",content:e});break;case"assistant":let o="";const r=[];for(const e of n.content)"text"===e.type?o+=e.text:"tool-call"===e.type&&r.push({toolCallId:e.toolCallId,toolName:e.toolName});o&&t.push({role:"assistant",content:o});break;case"tool":const s=I(n.content.map(N));t.push({role:"user",content:s})}return t}(e),d={messages:g,temperature:n,max_tokens:t,top_p:o,seed:c};return"json"===l?.type&&(d.response_format={type:"json_object"}),{messages:g,warnings:h,requestOptions:d,functionTools:p}}async doGenerate(e){const t=this.getArgs(e),{messages:n,warnings:o,requestOptions:r,functionTools:s}=t,{systemPrompt:i,messages:a}=P(n),l=$(a,w(i,s)),c=await this.getEngine(),u=async()=>{await c.interruptGenerate()};e.abortSignal&&e.abortSignal.addEventListener("abort",u);try{const t=await c.chat.completions.create({...r,messages:l,stream:!1,...e.abortSignal&&!this.config.options.worker&&{signal:e.abortSignal}}),n=t.choices[0];if(!n)throw new Error("No response choice returned from WebLLM");const s=n.message.content||"",{toolCalls:i,textContent:a}=k(s);if(i.length>0){const e=i.slice(0,1),n=[];a&&n.push({type:"text",text:a});for(const t of e)n.push({type:"tool-call",toolCallId:t.toolCallId,toolName:t.toolName,input:JSON.stringify(t.args??{})});return{content:n,finishReason:"tool-calls",usage:{inputTokens:t.usage?.prompt_tokens,outputTokens:t.usage?.completion_tokens,totalTokens:t.usage?.total_tokens},request:{body:{messages:l,...r}},warnings:o}}const u=[{type:"text",text:a||s}];let f="stop";return"abort"===n.finish_reason&&(f="other"),{content:u,finishReason:f,usage:{inputTokens:t.usage?.prompt_tokens,outputTokens:t.usage?.completion_tokens,totalTokens:t.usage?.total_tokens},request:{body:{messages:l,...r}},warnings:o}}catch(e){throw new Error(`WebLLM generation failed: ${e instanceof Error?e.message:"Unknown error"}`)}finally{e.abortSignal&&e.abortSignal.removeEventListener("abort",u)}}async availability(){return j()?this.isInitialized?"available":"downloadable":"unavailable"}async createSessionWithProgress(e){return this.getEngine(void 0,e)}async doStream(e){const t=this.getArgs(e),{messages:n,warnings:o,requestOptions:r,functionTools:s}=t,{systemPrompt:i,messages:a}=P(n),l=$(a,w(i,s)),c=await this.getEngine(),u=null!=this.config.options.worker,f=async()=>{await c.interruptGenerate()};e.abortSignal&&e.abortSignal.addEventListener("abort",f);const h="text-0";return{stream:new ReadableStream({async start(t){t.enqueue({type:"stream-start",warnings:o});let n=!1,s=!1;const i=e=>{e&&(n||(t.enqueue({type:"text-start",id:h}),n=!0),t.enqueue({type:"text-delta",id:h,delta:e}))},a=(e,o)=>{s||(s=!0,n&&(t.enqueue({type:"text-end",id:h}),n=!1),t.enqueue({type:"finish",finishReason:e,usage:{inputTokens:o?.prompt_tokens,outputTokens:o?.completion_tokens,totalTokens:o?.total_tokens}}),t.close())};try{const n={...r,messages:l,stream:!0,stream_options:{include_usage:!0},...e.abortSignal&&!u&&{signal:e.abortSignal}},o=await c.chat.completions.create(n),f=new W;let h="",p=null,m=!1,g="",d=0,b=!1;for await(const e of o){const n=e.choices[0];if(n){if(n.delta.content){const e=n.delta.content;for(h+=e,f.addChunk(e);f.hasContent();){const e=b,n=f.detectStreamingFence();b=n.inFence;let o=!1;if(e||!n.inFence){if(n.completeFence){if(o=!0,n.safeContent&&(g+=n.safeContent),m&&p){const e=B(g);if(e.length>d){const n=e.slice(d);d=e.length,n.length>0&&t.enqueue({type:"tool-input-delta",id:p,delta:n})}}const e=k(n.completeFence).toolCalls.slice(0,1);if(0===e.length){i(n.completeFence),n.textAfterFence&&i(n.textAfterFence),p=null,m=!1,g="",d=0,b=!1;continue}e.length>0&&p&&(e[0].toolCallId=p);for(const[n,o]of e.entries()){const e=0===n&&p?p:o.toolCallId,r=o.toolName,s=JSON.stringify(o.args??{});if(e===p){m||(t.enqueue({type:"tool-input-start",id:e,toolName:r}),m=!0);const n=B(g);if(n.length>d){const o=n.slice(d);d=n.length,o.length>0&&t.enqueue({type:"tool-input-delta",id:e,delta:o})}}else t.enqueue({type:"tool-input-start",id:e,toolName:r}),s.length>0&&t.enqueue({type:"tool-input-delta",id:e,delta:s});t.enqueue({type:"tool-input-end",id:e}),t.enqueue({type:"tool-call",toolCallId:e,toolName:r,input:s,providerExecuted:!1})}n.textAfterFence&&i(n.textAfterFence),o=!0,p=null,m=!1,g="",d=0,b=!1;continue}if(b){if(n.safeContent){g+=n.safeContent,o=!0;const e=z(g);if(e&&!m&&p&&(t.enqueue({type:"tool-input-start",id:p,toolName:e}),m=!0),m&&p){const e=B(g);if(e.length>d){const n=e.slice(d);d=e.length,n.length>0&&t.enqueue({type:"tool-input-delta",id:p,delta:n})}}}}else if(!b&&n.safeContent&&(i(n.safeContent),o=!0),!o)break}else n.safeContent&&(i(n.safeContent),o=!0),p=`call_${Date.now()}_${Math.random().toString(36).slice(2,9)}`,m=!1,g="",d=0,b=!0}}if(n.finish_reason){f.hasContent()&&(i(f.getBuffer()),f.clearBuffer());let t="stop";if("abort"===n.finish_reason)t="other";else{const{toolCalls:e}=k(h);e.length>0&&(t="tool-calls")}a(t,e.usage)}}}s||a("stop")}catch(e){t.error(e)}finally{e.abortSignal&&e.abortSignal.removeEventListener("abort",f),s||t.close()}}}),request:{body:{messages:l,...r}}}}},D=n(567);function J(e,t){return new R(e,t)}}}]);