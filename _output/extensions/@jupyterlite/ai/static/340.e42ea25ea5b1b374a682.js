"use strict";(self.webpackChunk_jupyterlite_ai=self.webpackChunk_jupyterlite_ai||[]).push([[340],{340:(e,t,s)=>{s.r(t),s.d(t,{Agent:()=>n.g6,AgentHooks:()=>n.u9,AgentsError:()=>n.pf,BatchTraceProcessor:()=>n.AF,ConsoleSpanExporter:()=>n.VD,GuardrailExecutionError:()=>n.yZ,Handoff:()=>n.Pj,InputGuardrailTripwireTriggered:()=>n.Fb,MCPServerSSE:()=>n.p2,MCPServerStdio:()=>n.l6,MCPServerStreamableHttp:()=>n.Wm,MaxTurnsExceededError:()=>n.MP,ModelBehaviorError:()=>n.af,NoopSpan:()=>n.fz,NoopTrace:()=>n.ih,OPENAI_DEFAULT_MODEL_ENV_VARIABLE_NAME:()=>n.ST,OpenAIChatCompletionsModel:()=>Yn,OpenAIProvider:()=>er,OpenAIResponsesModel:()=>Hn,OpenAITracingExporter:()=>tr,OutputGuardrailTripwireTriggered:()=>n.K6,RunAgentUpdatedStreamEvent:()=>n.gm,RunContext:()=>n.ZI,RunHandoffCallItem:()=>n.f_,RunHandoffOutputItem:()=>n.AU,RunItemStreamEvent:()=>n.R1,RunMessageOutputItem:()=>n.js,RunRawModelStreamEvent:()=>n.zG,RunReasoningItem:()=>n.ZS,RunResult:()=>n.ns,RunState:()=>n.ll,RunToolApprovalItem:()=>n.A9,RunToolCallItem:()=>n.nM,RunToolCallOutputItem:()=>n.KR,Runner:()=>n.by,RuntimeEventEmitter:()=>n.j3,Span:()=>n.L9,StreamedRunResult:()=>n.A1,SystemError:()=>n._N,ToolCallError:()=>n.Du,Trace:()=>n.Cn,TraceProvider:()=>n.hh,Usage:()=>n._U,UserError:()=>n.yo,addTraceProcessor:()=>n.VP,assistant:()=>n.h1,codeInterpreterTool:()=>En,computerTool:()=>n.ab,createAgentSpan:()=>n.M6,createCustomSpan:()=>n.ub,createFunctionSpan:()=>n.tQ,createGenerationSpan:()=>n.Xq,createGuardrailSpan:()=>n.Eu,createHandoffSpan:()=>n.DT,createMCPListToolsSpan:()=>n.ux,createMCPToolStaticFilter:()=>n.V4,createResponseSpan:()=>n.UI,createSpeechGroupSpan:()=>n.it,createSpeechSpan:()=>n.tL,createTranscriptionSpan:()=>n.B9,defineOutputGuardrail:()=>n._o,extractAllTextOutput:()=>n.ZV,fileSearchTool:()=>Tn,generateGroupId:()=>n.uA,generateSpanId:()=>n.ZF,generateTraceId:()=>n.el,getAllMcpTools:()=>n.Ph,getCurrentSpan:()=>n.YP,getCurrentTrace:()=>n.Co,getDefaultModel:()=>n.fZ,getDefaultModelSettings:()=>n.sL,getGlobalTraceProvider:()=>n.At,getHandoff:()=>n.Pu,getLogger:()=>n.tZ,getOrCreateTrace:()=>n.Nn,getTransferMessage:()=>n.Nx,gpt5ReasoningSettingsRequired:()=>n.Z5,handoff:()=>n.NS,hostedMcpTool:()=>n.cp,imageGenerationTool:()=>Cn,invalidateServerToolsCache:()=>n.qi,isGpt5Default:()=>n.w_,mcpToFunctionTool:()=>n.y6,protocol:()=>n.TB,realtime:()=>nr,resetCurrentSpan:()=>n.h6,run:()=>n.eF,setCurrentSpan:()=>n.mq,setDefaultModelProvider:()=>n.MJ,setDefaultOpenAIClient:()=>bn,setDefaultOpenAIKey:()=>xn,setDefaultOpenAITracingExporter:()=>sr,setOpenAIAPI:()=>vn,setTraceProcessors:()=>n.JA,setTracingDisabled:()=>n.dr,setTracingExportApiKey:()=>wn,startTraceExportLoop:()=>n.Qv,system:()=>n.qU,tool:()=>n.z6,user:()=>n.kQ,webSearchTool:()=>On,withAgentSpan:()=>n.mp,withCustomSpan:()=>n.Ee,withFunctionSpan:()=>n.PJ,withGenerationSpan:()=>n.hn,withGuardrailSpan:()=>n.cS,withHandoffSpan:()=>n.$t,withMCPListToolsSpan:()=>n.cW,withResponseSpan:()=>n.Cp,withSpeechGroupSpan:()=>n.UC,withSpeechSpan:()=>n.L0,withTrace:()=>n.SZ,withTranscriptionSpan:()=>n.LG});var n=s(6162);function r(e,t,s,n,r){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?r.call(e,s):r?r.value=s:t.set(e,s),s}function o(e,t,s,n){if("a"===s&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?n:"a"===s?n.call(e):n?n.value:t.get(e)}let i=function(){const{crypto:e}=globalThis;if(e?.randomUUID)return i=e.randomUUID.bind(e),e.randomUUID();const t=new Uint8Array(1),s=e?()=>e.getRandomValues(t)[0]:()=>255*Math.random()&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>(+e^s()&15>>+e/4).toString(16))};var a=s(2588);const l=/^[a-z][a-z0-9+.-]*:/i;let c=e=>(c=Array.isArray,c(e)),u=c;function d(e){return"object"!=typeof e?{}:e??{}}function p(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}const h=e=>new Promise(t=>setTimeout(t,e));var f=s(921);const m="5.23.2",g=()=>{const e="undefined"!=typeof Deno&&null!=Deno.build?"deno":"undefined"!=typeof EdgeRuntime?"edge":"[object process]"===Object.prototype.toString.call(void 0!==globalThis.process?globalThis.process:0)?"node":"unknown";if("deno"===e)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":m,"X-Stainless-OS":y(Deno.build.os),"X-Stainless-Arch":_(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":m,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if("node"===e)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":m,"X-Stainless-OS":y(globalThis.process.platform??"unknown"),"X-Stainless-Arch":_(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};const t=function(){if("undefined"==typeof navigator||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:s}of e){const e=s.exec(navigator.userAgent);if(e)return{browser:t,version:`${e[1]||0}.${e[2]||0}.${e[3]||0}`}}return null}();return t?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":m,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${t.browser}`,"X-Stainless-Runtime-Version":t.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":m,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}},_=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",y=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";let w;function v(...e){const t=globalThis.ReadableStream;if(void 0===t)throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new t(...e)}function b(e){let t=Symbol.asyncIterator in e?e[Symbol.asyncIterator]():e[Symbol.iterator]();return v({start(){},async pull(e){const{done:s,value:n}=await t.next();s?e.close():e.enqueue(n)},async cancel(){await(t.return?.())}})}function x(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){const e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const S=({headers:e,body:t})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(t)}),A="RFC3986",D=e=>String(e),k={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:D};let I=(e,t)=>(I=Object.hasOwn??Function.prototype.call.bind(Object.prototype.hasOwnProperty),I(e,t));const $=(()=>{const e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})(),R=1024;function O(e,t){if(c(e)){const s=[];for(let n=0;n<e.length;n+=1)s.push(t(e[n]));return s}return t(e)}const T={brackets:e=>String(e)+"[]",comma:"comma",indices:(e,t)=>String(e)+"["+t+"]",repeat:e=>String(e)},E=function(e,t){Array.prototype.push.apply(e,c(t)?t:[t])};let C;const P={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:(e,t,s,n,r)=>{if(0===e.length)return e;let o=e;if("symbol"==typeof e?o=Symbol.prototype.toString.call(e):"string"!=typeof e&&(o=String(e)),"iso-8859-1"===s)return escape(o).replace(/%u[0-9a-f]{4}/gi,function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"});let i="";for(let e=0;e<o.length;e+=R){const t=o.length>=R?o.slice(e,e+R):o,s=[];for(let e=0;e<t.length;++e){let n=t.charCodeAt(e);45===n||46===n||95===n||126===n||n>=48&&n<=57||n>=65&&n<=90||n>=97&&n<=122||"RFC1738"===r&&(40===n||41===n)?s[s.length]=t.charAt(e):n<128?s[s.length]=$[n]:n<2048?s[s.length]=$[192|n>>6]+$[128|63&n]:n<55296||n>=57344?s[s.length]=$[224|n>>12]+$[128|n>>6&63]+$[128|63&n]:(e+=1,n=65536+((1023&n)<<10|1023&t.charCodeAt(e)),s[s.length]=$[240|n>>18]+$[128|n>>12&63]+$[128|n>>6&63]+$[128|63&n])}i+=s.join("")}return i},encodeValuesOnly:!1,format:A,formatter:D,indices:!1,serializeDate:e=>(C??(C=Function.prototype.call.bind(Date.prototype.toISOString)))(e),skipNulls:!1,strictNullHandling:!1},M={};function q(e,t,s,n,r,o,i,a,l,u,d,p,h,f,m,g,_,y){let w=e,v=y,b=0,x=!1;for(;void 0!==(v=v.get(M))&&!x;){const t=v.get(e);if(b+=1,void 0!==t){if(t===b)throw new RangeError("Cyclic object value");x=!0}void 0===v.get(M)&&(b=0)}if("function"==typeof u?w=u(t,w):w instanceof Date?w=h?.(w):"comma"===s&&c(w)&&(w=O(w,function(e){return e instanceof Date?h?.(e):e})),null===w){if(o)return l&&!g?l(t,P.encoder,_,"key",f):t;w=""}if("string"==typeof(S=w)||"number"==typeof S||"boolean"==typeof S||"symbol"==typeof S||"bigint"==typeof S||function(e){return!(!e||"object"!=typeof e||!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e)))}(w)){if(l){const e=g?t:l(t,P.encoder,_,"key",f);return[m?.(e)+"="+m?.(l(w,P.encoder,_,"value",f))]}return[m?.(t)+"="+m?.(String(w))]}var S;const A=[];if(void 0===w)return A;let D;if("comma"===s&&c(w))g&&l&&(w=O(w,l)),D=[{value:w.length>0?w.join(",")||null:void 0}];else if(c(u))D=u;else{const e=Object.keys(w);D=d?e.sort(d):e}const k=a?String(t).replace(/\./g,"%2E"):String(t),I=n&&c(w)&&1===w.length?k+"[]":k;if(r&&c(w)&&0===w.length)return I+"[]";for(let t=0;t<D.length;++t){const v=D[t],x="object"==typeof v&&void 0!==v.value?v.value:w[v];if(i&&null===x)continue;const S=p&&a?v.replace(/\./g,"%2E"):v,k=c(w)?"function"==typeof s?s(I,S):I:I+(p?"."+S:"["+S+"]");y.set(e,b);const $=new WeakMap;$.set(M,y),E(A,q(x,k,s,n,r,o,i,a,"comma"===s&&g&&c(w)?null:l,u,d,p,h,f,m,g,_,$))}return A}let L,N;function j(e){let t;return(L??(t=new globalThis.TextEncoder,L=t.encode.bind(t)))(e)}function U(e){let t;return(N??(t=new globalThis.TextDecoder,N=t.decode.bind(t)))(e)}var B,W;class F{constructor(){B.set(this,void 0),W.set(this,void 0),r(this,B,new Uint8Array,"f"),r(this,W,null,"f")}decode(e){if(null==e)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):"string"==typeof e?j(e):e;r(this,B,function(e){let t=0;for(const s of e)t+=s.length;const s=new Uint8Array(t);let n=0;for(const t of e)s.set(t,n),n+=t.length;return s}([o(this,B,"f"),t]),"f");const s=[];let n;for(;null!=(n=H(o(this,B,"f"),o(this,W,"f")));){if(n.carriage&&null==o(this,W,"f")){r(this,W,n.index,"f");continue}if(null!=o(this,W,"f")&&(n.index!==o(this,W,"f")+1||n.carriage)){s.push(U(o(this,B,"f").subarray(0,o(this,W,"f")-1))),r(this,B,o(this,B,"f").subarray(o(this,W,"f")),"f"),r(this,W,null,"f");continue}const e=null!==o(this,W,"f")?n.preceding-1:n.preceding,t=U(o(this,B,"f").subarray(0,e));s.push(t),r(this,B,o(this,B,"f").subarray(n.index),"f"),r(this,W,null,"f")}return s}flush(){return o(this,B,"f").length?this.decode("\n"):[]}}function H(e,t){for(let s=t??0;s<e.length;s++){if(10===e[s])return{preceding:s,index:s+1,carriage:!1};if(13===e[s])return{preceding:s,index:s+1,carriage:!0}}return null}function J(e){for(let t=0;t<e.length-1;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}B=new WeakMap,W=new WeakMap,F.NEWLINE_CHARS=new Set(["\n","\r"]),F.NEWLINE_REGEXP=/\r\n|[\n\r]/g;const K={off:0,error:200,warn:300,info:400,debug:500},X=(e,t,s)=>{var n,r;if(e)return n=K,r=e,Object.prototype.hasOwnProperty.call(n,r)?e:void Z(s).warn(`${t} was set to ${JSON.stringify(e)}, expected one of ${JSON.stringify(Object.keys(K))}`)};function z(){}function G(e,t,s){return!t||K[e]>K[s]?z:t[e].bind(t)}const V={error:z,warn:z,info:z,debug:z};let Q=new WeakMap;function Z(e){const t=e.logger,s=e.logLevel??"off";if(!t)return V;const n=Q.get(t);if(n&&n[0]===s)return n[1];const r={error:G("error",t,s),warn:G("warn",t,s),info:G("info",t,s),debug:G("debug",t,s)};return Q.set(t,[s,r]),r}const Y=e=>(e.options&&(e.options={...e.options},delete e.options.headers),e.headers&&(e.headers=Object.fromEntries((e.headers instanceof Headers?[...e.headers]:Object.entries(e.headers)).map(([e,t])=>[e,"authorization"===e.toLowerCase()||"cookie"===e.toLowerCase()||"set-cookie"===e.toLowerCase()?"***":t]))),"retryOfRequestLogID"in e&&(e.retryOfRequestLogID&&(e.retryOf=e.retryOfRequestLogID),delete e.retryOfRequestLogID),e);var ee,te,se;class ne{constructor(e,t,s){this.iterator=e,ee.set(this,void 0),this.controller=t,r(this,ee,s,"f")}static fromSSEResponse(e,t,s){let n=!1;const r=s?Z(s):console;return new ne(async function*(){if(n)throw new a.vc("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let s=!1;try{for await(const n of async function*(e,t){if(!e.body){if(t.abort(),void 0!==globalThis.navigator&&"ReactNative"===globalThis.navigator.product)throw new a.vc("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api");throw new a.vc("Attempted to iterate over a response with no body")}const s=new re,n=new F,r=x(e.body);for await(const e of async function*(e){let t=new Uint8Array;for await(const s of e){if(null==s)continue;const e=s instanceof ArrayBuffer?new Uint8Array(s):"string"==typeof s?j(s):s;let n,r=new Uint8Array(t.length+e.length);for(r.set(t),r.set(e,t.length),t=r;-1!==(n=J(t));)yield t.slice(0,n),t=t.slice(n)}t.length>0&&(yield t)}(r))for(const t of n.decode(e)){const e=s.decode(t);e&&(yield e)}for(const e of n.flush()){const t=s.decode(e);t&&(yield t)}}(e,t))if(!s)if(n.data.startsWith("[DONE]"))s=!0;else if(null!==n.event&&n.event.startsWith("thread.")){let e;try{e=JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if("error"==n.event)throw new a.LG(void 0,e.error,e.message,void 0);yield{event:n.event,data:e}}else{let t;try{t=JSON.parse(n.data)}catch(e){throw r.error("Could not parse message into JSON:",n.data),r.error("From chunk:",n.raw),e}if(t&&t.error)throw new a.LG(void 0,t.error,void 0,e.headers);yield t}s=!0}catch(e){if((0,f.z)(e))return;throw e}finally{s||t.abort()}},t,s)}static fromReadableStream(e,t,s){let n=!1;return new ne(async function*(){if(n)throw new a.vc("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let s=!1;try{for await(const t of async function*(){const t=new F,s=x(e);for await(const e of s)for(const s of t.decode(e))yield s;for(const e of t.flush())yield e}())s||t&&(yield JSON.parse(t));s=!0}catch(e){if((0,f.z)(e))return;throw e}finally{s||t.abort()}},t,s)}[(ee=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){const e=[],t=[],s=this.iterator(),n=n=>({next:()=>{if(0===n.length){const n=s.next();e.push(n),t.push(n)}return n.shift()}});return[new ne(()=>n(e),this.controller,o(this,ee,"f")),new ne(()=>n(t),this.controller,o(this,ee,"f"))]}toReadableStream(){const e=this;let t;return v({async start(){t=e[Symbol.asyncIterator]()},async pull(e){try{const{value:s,done:n}=await t.next();if(n)return e.close();const r=j(JSON.stringify(s)+"\n");e.enqueue(r)}catch(t){e.error(t)}},async cancel(){await(t.return?.())}})}}class re{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,s,n]=function(e){const t=e.indexOf(":");return-1!==t?[e.substring(0,t),":",e.substring(t+1)]:[e,"",""]}(e);return n.startsWith(" ")&&(n=n.substring(1)),"event"===t?this.event=n:"data"===t&&this.data.push(n),null}}async function oe(e,t){const{response:s,requestLogID:n,retryOfRequestLogID:r,startTime:o}=t,i=await(async()=>{if(t.options.stream)return Z(e).debug("response",s.status,s.url,s.headers,s.body),t.options.__streamClass?t.options.__streamClass.fromSSEResponse(s,t.controller,e):ne.fromSSEResponse(s,t.controller,e);if(204===s.status)return null;if(t.options.__binaryResponse)return s;const n=s.headers.get("content-type"),r=n?.split(";")[0]?.trim();return r?.includes("application/json")||r?.endsWith("+json")?ie(await s.json(),s):await s.text()})();return Z(e).debug(`[${n}] response parsed`,Y({retryOfRequestLogID:r,url:s.url,status:s.status,body:i,durationMs:Date.now()-o})),i}function ie(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}class ae extends Promise{constructor(e,t,s=oe){super(e=>{e(null)}),this.responsePromise=t,this.parseResponse=s,te.set(this,void 0),r(this,te,e,"f")}_thenUnwrap(e){return new ae(o(this,te,"f"),this.responsePromise,async(t,s)=>ie(e(await this.parseResponse(t,s),s),s.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(o(this,te,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}te=new WeakMap;class le{constructor(e,t,s,n){se.set(this,void 0),r(this,se,e,"f"),this.options=n,this.response=t,this.body=s}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageRequestOptions()}async getNextPage(){const e=this.nextPageRequestOptions();if(!e)throw new a.vc("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await o(this,se,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(se=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class ce extends ae{constructor(e,t,s){super(e,t,async(e,t)=>new s(e,t.response,await oe(e,t),t.options))}async*[Symbol.asyncIterator](){const e=await(this);for await(const t of e)yield t}}class ue extends le{constructor(e,t,s,n){super(e,t,s,n),this.data=s.data||[],this.object=s.object}getPaginatedItems(){return this.data??[]}nextPageRequestOptions(){return null}}class de extends le{constructor(e,t,s,n){super(e,t,s,n),this.data=s.data||[],this.has_more=s.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageRequestOptions(){const e=this.getPaginatedItems(),t=e[e.length-1]?.id;return t?{...this.options,query:{...d(this.options.query),after:t}}:null}}class pe extends le{constructor(e,t,s,n){super(e,t,s,n),this.data=s.data||[],this.has_more=s.has_more||!1,this.last_id=s.last_id||""}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageRequestOptions(){const e=this.last_id;return e?{...this.options,query:{...d(this.options.query),after:e}}:null}}const he=()=>{if("undefined"==typeof File){const{process:e}=globalThis,t="string"==typeof e?.versions?.node&&parseInt(e.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(t?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function fe(e,t,s){return he(),new File(e,t??"unknown_file",s)}function me(e){return("object"==typeof e&&null!==e&&("name"in e&&e.name&&String(e.name)||"url"in e&&e.url&&String(e.url)||"filename"in e&&e.filename&&String(e.filename)||"path"in e&&e.path&&String(e.path))||"").split(/[\\/]/).pop()||void 0}const ge=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],_e=async(e,t)=>({...e,body:await we(e.body,t)}),ye=new WeakMap,we=async(e,t)=>{if(!await function(e){const t="function"==typeof e?e:e.fetch,s=ye.get(t);if(s)return s;const n=(async()=>{try{const e="Response"in t?t.Response:(await t("data:,")).constructor,s=new FormData;return s.toString()!==await new e(s).text()}catch{return!0}})();return ye.set(t,n),n}(t))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");const s=new FormData;return await Promise.all(Object.entries(e||{}).map(([e,t])=>ve(s,e,t))),s},ve=async(e,t,s)=>{if(void 0!==s){if(null==s)throw new TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof s||"number"==typeof s||"boolean"==typeof s)e.append(t,String(s));else if(s instanceof Response)e.append(t,fe([await s.blob()],me(s)));else if(ge(s))e.append(t,fe([await new Response(b(s)).blob()],me(s)));else if((e=>e instanceof Blob&&"name"in e)(s))e.append(t,s,me(s));else if(Array.isArray(s))await Promise.all(s.map(s=>ve(e,t+"[]",s)));else{if("object"!=typeof s)throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${s} instead`);await Promise.all(Object.entries(s).map(([s,n])=>ve(e,`${t}[${s}]`,n)))}}},be=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer;async function xe(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(be(e))t.push(e instanceof Blob?e:await e.arrayBuffer());else{if(!ge(e)){const t=e?.constructor?.name;throw new Error(`Unexpected data type: ${typeof e}${t?`; constructor: ${t}`:""}${function(e){if("object"!=typeof e||null===e)return"";return`; props: [${Object.getOwnPropertyNames(e).map(e=>`"${e}"`).join(", ")}]`}(e)}`)}for await(const s of e)t.push(...await xe(s))}return t}class Se{constructor(e){this._client=e}}function Ae(e){return e.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}const De=Object.freeze(Object.create(null)),ke=(e=Ae)=>function(t,...s){if(1===t.length)return t[0];let n=!1;const r=[],o=t.reduce((t,o,i)=>{/[?#]/.test(o)&&(n=!0);const a=s[i];let l=(n?encodeURIComponent:e)(""+a);return i!==s.length&&(null==a||"object"==typeof a&&a.toString===Object.getPrototypeOf(Object.getPrototypeOf(a.hasOwnProperty??De)??De)?.toString)&&(l=a+"",r.push({start:t.length+o.length,length:l.length,error:`Value of type ${Object.prototype.toString.call(a).slice(8,-1)} is not a valid path parameter`})),t+o+(i===s.length?"":l)},""),i=o.split(/[?#]/,1)[0],l=/(?<=^|\/)(?:\.|%2e){1,2}(?=\/|$)/gi;let c;for(;null!==(c=l.exec(i));)r.push({start:c.index,length:c[0].length,error:`Value "${c[0]}" can't be safely passed as a path parameter`});if(r.sort((e,t)=>e.start-t.start),r.length>0){let e=0;const t=r.reduce((t,s)=>{const n=" ".repeat(s.start-e),r="^".repeat(s.length);return e=s.start+s.length,t+n+r},"");throw new a.vc(`Path parameters result in path with invalid segments:\n${r.map(e=>e.error).join("\n")}\n${o}\n${t}`)}return o},Ie=ke(Ae);class $e extends Se{list(e,t={},s){return this._client.getAPIList(Ie`/chat/completions/${e}/messages`,de,{query:t,...s})}}var Re=s(7036),Oe=s(9731);const Te=e=>"assistant"===e?.role,Ee=e=>"tool"===e?.role;var Ce,Pe,Me,qe,Le,Ne,je,Ue,Be,We,Fe,He,Je,Ke,Xe,ze,Ge,Ve,Qe,Ze,Ye;class et{constructor(){Ce.add(this),this.controller=new AbortController,Pe.set(this,void 0),Me.set(this,()=>{}),qe.set(this,()=>{}),Le.set(this,void 0),Ne.set(this,()=>{}),je.set(this,()=>{}),Ue.set(this,{}),Be.set(this,!1),We.set(this,!1),Fe.set(this,!1),He.set(this,!1),r(this,Pe,new Promise((e,t)=>{r(this,Me,e,"f"),r(this,qe,t,"f")}),"f"),r(this,Le,new Promise((e,t)=>{r(this,Ne,e,"f"),r(this,je,t,"f")}),"f"),o(this,Pe,"f").catch(()=>{}),o(this,Le,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},o(this,Ce,"m",Je).bind(this))},0)}_connected(){this.ended||(o(this,Me,"f").call(this),this._emit("connect"))}get ended(){return o(this,Be,"f")}get errored(){return o(this,We,"f")}get aborted(){return o(this,Fe,"f")}abort(){this.controller.abort()}on(e,t){return(o(this,Ue,"f")[e]||(o(this,Ue,"f")[e]=[])).push({listener:t}),this}off(e,t){const s=o(this,Ue,"f")[e];if(!s)return this;const n=s.findIndex(e=>e.listener===t);return n>=0&&s.splice(n,1),this}once(e,t){return(o(this,Ue,"f")[e]||(o(this,Ue,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,s)=>{r(this,He,!0,"f"),"error"!==e&&this.once("error",s),this.once(e,t)})}async done(){r(this,He,!0,"f"),await o(this,Le,"f")}_emit(e,...t){if(o(this,Be,"f"))return;"end"===e&&(r(this,Be,!0,"f"),o(this,Ne,"f").call(this));const s=o(this,Ue,"f")[e];if(s&&(o(this,Ue,"f")[e]=s.filter(e=>!e.once),s.forEach(({listener:e})=>e(...t))),"abort"===e){const e=t[0];return o(this,He,"f")||s?.length||Promise.reject(e),o(this,qe,"f").call(this,e),o(this,je,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];o(this,He,"f")||s?.length||Promise.reject(e),o(this,qe,"f").call(this,e),o(this,je,"f").call(this,e),this._emit("end")}}_emitFinal(){}}function tt(e){return"function"==typeof e.parse}Pe=new WeakMap,Me=new WeakMap,qe=new WeakMap,Le=new WeakMap,Ne=new WeakMap,je=new WeakMap,Ue=new WeakMap,Be=new WeakMap,We=new WeakMap,Fe=new WeakMap,He=new WeakMap,Ce=new WeakSet,Je=function(e){if(r(this,We,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new Re.cH),e instanceof Re.cH)return r(this,Fe,!0,"f"),this._emit("abort",e);if(e instanceof Re.vc)return this._emit("error",e);if(e instanceof Error){const t=new Re.vc(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new Re.vc(String(e)))};const st=10;class nt extends et{constructor(){super(...arguments),Ke.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t)if(this._emit("message",e),Ee(e)&&e.content)this._emit("functionToolCallResult",e.content);else if(Te(e)&&e.tool_calls)for(const t of e.tool_calls)"function"===t.type&&this._emit("functionToolCall",t.function)}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new Re.vc("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),o(this,Ke,"m",Xe).call(this)}async finalMessage(){return await this.done(),o(this,Ke,"m",ze).call(this)}async finalFunctionToolCall(){return await this.done(),o(this,Ke,"m",Ge).call(this)}async finalFunctionToolCallResult(){return await this.done(),o(this,Ke,"m",Ve).call(this)}async totalUsage(){return await this.done(),o(this,Ke,"m",Qe).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=o(this,Ke,"m",ze).call(this);t&&this._emit("finalMessage",t);const s=o(this,Ke,"m",Xe).call(this);s&&this._emit("finalContent",s);const n=o(this,Ke,"m",Ge).call(this);n&&this._emit("finalFunctionToolCall",n);const r=o(this,Ke,"m",Ve).call(this);null!=r&&this._emit("finalFunctionToolCallResult",r),this._chatCompletions.some(e=>e.usage)&&this._emit("totalUsage",o(this,Ke,"m",Qe).call(this))}async _createChatCompletion(e,t,s){const n=s?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),o(this,Ke,"m",Ze).call(this,t);const r=await e.chat.completions.create({...t,stream:!1},{...s,signal:this.controller.signal});return this._connected(),this._addChatCompletion((0,Oe.ie)(r,t))}async _runChatCompletion(e,t,s){for(const e of t.messages)this._addMessage(e,!1);return await this._createChatCompletion(e,t,s)}async _runTools(e,t,s){const n="tool",{tool_choice:r="auto",stream:i,...a}=t,l="string"!=typeof r&&"function"===r.type&&r?.function?.name,{maxChatCompletions:c=st}=s||{},u=t.tools.map(e=>{if((0,Oe.i_)(e)){if(!e.$callback)throw new Re.vc("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:e.$callback,name:e.function.name,description:e.function.description||"",parameters:e.function.parameters,parse:e.$parseRaw,strict:!0}}}return e}),d={};for(const e of u)"function"===e.type&&(d[e.function.name||e.function.function.name]=e.function);const p="tools"in t?u.map(e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description,strict:e.function.strict}}:e):void 0;for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<c;++t){const t=await this._createChatCompletion(e,{...a,tool_choice:r,tools:p,messages:[...this.messages]},s),i=t.choices[0]?.message;if(!i)throw new Re.vc("missing message in ChatCompletion response");if(!i.tool_calls?.length)return;for(const e of i.tool_calls){if("function"!==e.type)continue;const t=e.id,{name:s,arguments:r}=e.function,i=d[s];if(!i){const e=`Invalid tool_call: ${JSON.stringify(s)}. Available options are: ${Object.keys(d).map(e=>JSON.stringify(e)).join(", ")}. Please try again`;this._addMessage({role:n,tool_call_id:t,content:e});continue}if(l&&l!==s){const e=`Invalid tool_call: ${JSON.stringify(s)}. ${JSON.stringify(l)} requested. Please try again`;this._addMessage({role:n,tool_call_id:t,content:e});continue}let a;try{a=tt(i)?await i.parse(r):r}catch(e){const s=e instanceof Error?e.message:String(e);this._addMessage({role:n,tool_call_id:t,content:s});continue}const c=await i.function(a,this),u=o(this,Ke,"m",Ye).call(this,c);if(this._addMessage({role:n,tool_call_id:t,content:u}),l)return}}}}Ke=new WeakSet,Xe=function(){return o(this,Ke,"m",ze).call(this).content??null},ze=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(Te(t))return{...t,content:t.content??null,refusal:t.refusal??null}}throw new Re.vc("stream ended without producing a ChatCompletionMessage with role=assistant")},Ge=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Te(t)&&t?.tool_calls?.length)return t.tool_calls.filter(e=>"function"===e.type).at(-1)?.function}},Ve=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Ee(t)&&null!=t.content&&"string"==typeof t.content&&this.messages.some(e=>"assistant"===e.role&&e.tool_calls?.some(e=>"function"===e.type&&e.id===t.tool_call_id)))return t.content}},Qe=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},Ze=function(e){if(null!=e.n&&e.n>1)throw new Re.vc("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},Ye=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};class rt extends nt{static runTools(e,t,s){const n=new rt,r={...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"runTools"}};return n._run(()=>n._runTools(e,t,r)),n}_addMessage(e,t=!0){super._addMessage(e,t),Te(e)&&e.content&&this._emit("content",e.content)}}class ot extends Error{}class it extends Error{}const at=e=>function(e,t=511){if("string"!=typeof e)throw new TypeError("expecting str, got "+typeof e);if(!e.trim())throw new Error(`${e} is empty`);return((e,t)=>{const s=e.length;let n=0;const r=e=>{throw new ot(`${e} at position ${n}`)},o=e=>{throw new it(`${e} at position ${n}`)},i=()=>(d(),n>=s&&r("Unexpected end of input"),'"'===e[n]?a():"{"===e[n]?l():"["===e[n]?c():"null"===e.substring(n,n+4)||16&t&&s-n<4&&"null".startsWith(e.substring(n))?(n+=4,null):"true"===e.substring(n,n+4)||32&t&&s-n<4&&"true".startsWith(e.substring(n))?(n+=4,!0):"false"===e.substring(n,n+5)||32&t&&s-n<5&&"false".startsWith(e.substring(n))?(n+=5,!1):"Infinity"===e.substring(n,n+8)||128&t&&s-n<8&&"Infinity".startsWith(e.substring(n))?(n+=8,1/0):"-Infinity"===e.substring(n,n+9)||256&t&&1<s-n&&s-n<9&&"-Infinity".startsWith(e.substring(n))?(n+=9,-1/0):"NaN"===e.substring(n,n+3)||64&t&&s-n<3&&"NaN".startsWith(e.substring(n))?(n+=3,NaN):u()),a=()=>{const i=n;let a=!1;for(n++;n<s&&('"'!==e[n]||a&&"\\"===e[n-1]);)a="\\"===e[n]&&!a,n++;if('"'==e.charAt(n))try{return JSON.parse(e.substring(i,++n-Number(a)))}catch(e){o(String(e))}else if(1&t)try{return JSON.parse(e.substring(i,n-Number(a))+'"')}catch(t){return JSON.parse(e.substring(i,e.lastIndexOf("\\"))+'"')}r("Unterminated string literal")},l=()=>{n++,d();const o={};try{for(;"}"!==e[n];){if(d(),n>=s&&8&t)return o;const r=a();d(),n++;try{const e=i();Object.defineProperty(o,r,{value:e,writable:!0,enumerable:!0,configurable:!0})}catch(e){if(8&t)return o;throw e}d(),","===e[n]&&n++}}catch(e){if(8&t)return o;r("Expected '}' at end of object")}return n++,o},c=()=>{n++;const s=[];try{for(;"]"!==e[n];)s.push(i()),d(),","===e[n]&&n++}catch(e){if(4&t)return s;r("Expected ']' at end of array")}return n++,s},u=()=>{if(0===n){"-"===e&&2&t&&r("Not sure what '-' is");try{return JSON.parse(e)}catch(s){if(2&t)try{return"."===e[e.length-1]?JSON.parse(e.substring(0,e.lastIndexOf("."))):JSON.parse(e.substring(0,e.lastIndexOf("e")))}catch(e){}o(String(s))}}const i=n;for("-"===e[n]&&n++;e[n]&&!",]}".includes(e[n]);)n++;n!=s||2&t||r("Unterminated number literal");try{return JSON.parse(e.substring(i,n))}catch(s){"-"===e.substring(i,n)&&2&t&&r("Not sure what '-' is");try{return JSON.parse(e.substring(i,e.lastIndexOf("e")))}catch(e){o(String(e))}}},d=()=>{for(;n<s&&" \n\r\t".includes(e[n]);)n++};return i()})(e.trim(),t)}(e,509);var lt,ct,ut,dt,pt,ht,ft,mt,gt,_t,yt,wt;class vt extends nt{constructor(e){super(),lt.add(this),ct.set(this,void 0),ut.set(this,void 0),dt.set(this,void 0),r(this,ct,e,"f"),r(this,ut,[],"f")}get currentChatCompletionSnapshot(){return o(this,dt,"f")}static fromReadableStream(e){const t=new vt(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,s){const n=new vt(t);return n._run(()=>n._runChatCompletion(e,{...t,stream:!0},{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),n}async _createChatCompletion(e,t,s){super._createChatCompletion;const n=s?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),o(this,lt,"m",pt).call(this);const r=await e.chat.completions.create({...t,stream:!0},{...s,signal:this.controller.signal});this._connected();for await(const e of r)o(this,lt,"m",ft).call(this,e);if(r.controller.signal?.aborted)throw new Re.cH;return this._addChatCompletion(o(this,lt,"m",_t).call(this))}async _fromReadableStream(e,t){const s=t?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),o(this,lt,"m",pt).call(this),this._connected();const n=ne.fromReadableStream(e,this.controller);let r;for await(const e of n)r&&r!==e.id&&this._addChatCompletion(o(this,lt,"m",_t).call(this)),o(this,lt,"m",ft).call(this,e),r=e.id;if(n.controller.signal?.aborted)throw new Re.cH;return this._addChatCompletion(o(this,lt,"m",_t).call(this))}[(ct=new WeakMap,ut=new WeakMap,dt=new WeakMap,lt=new WeakSet,pt=function(){this.ended||r(this,dt,void 0,"f")},ht=function(e){let t=o(this,ut,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},o(this,ut,"f")[e.index]=t,t)},ft=function(e){if(this.ended)return;const t=o(this,lt,"m",wt).call(this,e);this._emit("chunk",e,t);for(const s of e.choices){const e=t.choices[s.index];null!=s.delta.content&&"assistant"===e.message?.role&&e.message?.content&&(this._emit("content",s.delta.content,e.message.content),this._emit("content.delta",{delta:s.delta.content,snapshot:e.message.content,parsed:e.message.parsed})),null!=s.delta.refusal&&"assistant"===e.message?.role&&e.message?.refusal&&this._emit("refusal.delta",{delta:s.delta.refusal,snapshot:e.message.refusal}),null!=s.logprobs?.content&&"assistant"===e.message?.role&&this._emit("logprobs.content.delta",{content:s.logprobs?.content,snapshot:e.logprobs?.content??[]}),null!=s.logprobs?.refusal&&"assistant"===e.message?.role&&this._emit("logprobs.refusal.delta",{refusal:s.logprobs?.refusal,snapshot:e.logprobs?.refusal??[]});const n=o(this,lt,"m",ht).call(this,e);e.finish_reason&&(o(this,lt,"m",gt).call(this,e),null!=n.current_tool_call_index&&o(this,lt,"m",mt).call(this,e,n.current_tool_call_index));for(const t of s.delta.tool_calls??[])n.current_tool_call_index!==t.index&&(o(this,lt,"m",gt).call(this,e),null!=n.current_tool_call_index&&o(this,lt,"m",mt).call(this,e,n.current_tool_call_index)),n.current_tool_call_index=t.index;for(const t of s.delta.tool_calls??[]){const s=e.message.tool_calls?.[t.index];s?.type&&("function"===s?.type?this._emit("tool_calls.function.arguments.delta",{name:s.function?.name,index:t.index,arguments:s.function.arguments,parsed_arguments:s.function.parsed_arguments,arguments_delta:t.function?.arguments??""}):St())}}},mt=function(e,t){if(o(this,lt,"m",ht).call(this,e).done_tool_calls.has(t))return;const s=e.message.tool_calls?.[t];if(!s)throw new Error("no tool call snapshot");if(!s.type)throw new Error("tool call snapshot missing `type`");if("function"===s.type){const e=o(this,ct,"f")?.tools?.find(e=>(0,Oe.Tw)(e)&&e.function.name===s.function.name);this._emit("tool_calls.function.arguments.done",{name:s.function.name,index:t,arguments:s.function.arguments,parsed_arguments:(0,Oe.i_)(e)?e.$parseRaw(s.function.arguments):e?.function.strict?JSON.parse(s.function.arguments):null})}else s.type},gt=function(e){const t=o(this,lt,"m",ht).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;const s=o(this,lt,"m",yt).call(this);this._emit("content.done",{content:e.message.content,parsed:s?s.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),e.logprobs?.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),e.logprobs?.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},_t=function(){if(this.ended)throw new Re.vc("stream has ended, this shouldn't happen");const e=o(this,dt,"f");if(!e)throw new Re.vc("request ended without sending any chunks");return r(this,dt,void 0,"f"),r(this,ut,[],"f"),function(e,t){const{id:s,choices:n,created:r,model:o,system_fingerprint:i,...a}=e,l={...a,id:s,choices:n.map(({message:t,finish_reason:s,index:n,logprobs:r,...o})=>{if(!s)throw new Re.vc(`missing finish_reason for choice ${n}`);const{content:i=null,function_call:a,tool_calls:l,...c}=t,u=t.role;if(!u)throw new Re.vc(`missing role for choice ${n}`);if(a){const{arguments:e,name:l}=a;if(null==e)throw new Re.vc(`missing function_call.arguments for choice ${n}`);if(!l)throw new Re.vc(`missing function_call.name for choice ${n}`);return{...o,message:{content:i,function_call:{arguments:e,name:l},role:u,refusal:t.refusal??null},finish_reason:s,index:n,logprobs:r}}return l?{...o,index:n,finish_reason:s,logprobs:r,message:{...c,role:u,content:i,refusal:t.refusal??null,tool_calls:l.map((t,s)=>{const{function:r,type:o,id:i,...a}=t,{arguments:l,name:c,...u}=r||{};if(null==i)throw new Re.vc(`missing choices[${n}].tool_calls[${s}].id\n${bt(e)}`);if(null==o)throw new Re.vc(`missing choices[${n}].tool_calls[${s}].type\n${bt(e)}`);if(null==c)throw new Re.vc(`missing choices[${n}].tool_calls[${s}].function.name\n${bt(e)}`);if(null==l)throw new Re.vc(`missing choices[${n}].tool_calls[${s}].function.arguments\n${bt(e)}`);return{...a,id:i,type:o,function:{...u,name:c,arguments:l}}})}}:{...o,message:{...c,content:i,role:u,refusal:t.refusal??null},finish_reason:s,index:n,logprobs:r}}),created:r,model:o,object:"chat.completion",...i?{system_fingerprint:i}:{}};return(0,Oe.OJ)(l,t)}(e,o(this,ct,"f"))},yt=function(){const e=o(this,ct,"f")?.response_format;return(0,Oe.U)(e)?e:null},wt=function(e){var t,s,n,i;let a=o(this,dt,"f");const{choices:l,...c}=e;a?Object.assign(a,c):a=r(this,dt,{...c,choices:[]},"f");for(const{delta:r,finish_reason:l,index:c,logprobs:u=null,...d}of e.choices){let e=a.choices[c];if(e||(e=a.choices[c]={finish_reason:l,index:c,message:{},logprobs:u,...d}),u)if(e.logprobs){const{content:n,refusal:r,...o}=u;xt(),Object.assign(e.logprobs,o),n&&((t=e.logprobs).content??(t.content=[]),e.logprobs.content.push(...n)),r&&((s=e.logprobs).refusal??(s.refusal=[]),e.logprobs.refusal.push(...r))}else e.logprobs=Object.assign({},u);if(l&&(e.finish_reason=l,o(this,ct,"f")&&(0,Oe.d4)(o(this,ct,"f")))){if("length"===l)throw new Re.k5;if("content_filter"===l)throw new Re.pf}if(Object.assign(e,d),!r)continue;const{content:p,refusal:h,function_call:f,role:m,tool_calls:g,..._}=r;if(xt(),Object.assign(e.message,_),h&&(e.message.refusal=(e.message.refusal||"")+h),m&&(e.message.role=m),f&&(e.message.function_call?(f.name&&(e.message.function_call.name=f.name),f.arguments&&((n=e.message.function_call).arguments??(n.arguments=""),e.message.function_call.arguments+=f.arguments)):e.message.function_call=f),p&&(e.message.content=(e.message.content||"")+p,!e.message.refusal&&o(this,lt,"m",yt).call(this)&&(e.message.parsed=at(e.message.content))),g){e.message.tool_calls||(e.message.tool_calls=[]);for(const{index:t,id:s,type:n,function:r,...a}of g){const l=(i=e.message.tool_calls)[t]??(i[t]={});Object.assign(l,a),s&&(l.id=s),n&&(l.type=n),r&&(l.function??(l.function={name:r.name??"",arguments:""})),r?.name&&(l.function.name=r.name),r?.arguments&&(l.function.arguments+=r.arguments,(0,Oe.tp)(o(this,ct,"f"),l)&&(l.function.parsed_arguments=at(l.function.arguments)))}}}return a},Symbol.asyncIterator)](){const e=[],t=[];let s=!1;return this.on("chunk",s=>{const n=t.shift();n?n.resolve(s):e.push(s)}),this.on("end",()=>{s=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{s=!0;for(const s of t)s.reject(e);t.length=0}),this.on("error",e=>{s=!0;for(const s of t)s.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((e,s)=>t.push({resolve:e,reject:s})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new ne(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function bt(e){return JSON.stringify(e)}function xt(e){}function St(e){}class At extends vt{static fromReadableStream(e){const t=new At(null);return t._run(()=>t._fromReadableStream(e)),t}static runTools(e,t,s){const n=new At(t),r={...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"runTools"}};return n._run(()=>n._runTools(e,t,r)),n}}class Dt extends Se{constructor(){super(...arguments),this.messages=new $e(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(Ie`/chat/completions/${e}`,t)}update(e,t,s){return this._client.post(Ie`/chat/completions/${e}`,{body:t,...s})}list(e={},t){return this._client.getAPIList("/chat/completions",de,{query:e,...t})}delete(e,t){return this._client.delete(Ie`/chat/completions/${e}`,t)}parse(e,t){return(0,Oe.cz)(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"chat.completions.parse"}})._thenUnwrap(t=>(0,Oe.ie)(t,e))}runTools(e,t){return e.stream?At.runTools(this._client,e,t):rt.runTools(this._client,e,t)}stream(e,t){return vt.createChatCompletion(this._client,e,t)}}Dt.Messages=$e;class kt extends Se{constructor(){super(...arguments),this.completions=new Dt(this._client)}}kt.Completions=Dt;const It=Symbol("brand.privateNullableHeaders");function*$t(e){if(!e)return;if(It in e){const{values:t,nulls:s}=e;yield*t.entries();for(const e of s)yield[e,null];return}let t,s=!1;e instanceof Headers?t=e.entries():u(e)?t=e:(s=!0,t=Object.entries(e??{}));for(let e of t){const t=e[0];if("string"!=typeof t)throw new TypeError("expected header name to be a string");const n=u(e[1])?e[1]:[e[1]];let r=!1;for(const e of n)void 0!==e&&(s&&!r&&(r=!0,yield[t,null]),yield[t,e])}}const Rt=e=>{const t=new Headers,s=new Set;for(const n of e){const e=new Set;for(const[r,o]of $t(n)){const n=r.toLowerCase();e.has(n)||(t.delete(r),e.add(n)),null===o?(t.delete(r),s.add(n)):(t.append(r,o),s.delete(n))}}return{[It]:!0,values:t,nulls:s}};class Ot extends Se{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:Rt([{Accept:"application/octet-stream"},t?.headers]),__binaryResponse:!0})}}class Tt extends Se{create(e,t){return this._client.post("/audio/transcriptions",_e({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}},this._client))}}class Et extends Se{create(e,t){return this._client.post("/audio/translations",_e({body:e,...t,__metadata:{model:e.model}},this._client))}}class Ct extends Se{constructor(){super(...arguments),this.transcriptions=new Tt(this._client),this.translations=new Et(this._client),this.speech=new Ot(this._client)}}Ct.Transcriptions=Tt,Ct.Translations=Et,Ct.Speech=Ot;class Pt extends Se{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(Ie`/batches/${e}`,t)}list(e={},t){return this._client.getAPIList("/batches",de,{query:e,...t})}cancel(e,t){return this._client.post(Ie`/batches/${e}/cancel`,t)}}class Mt extends Se{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:Rt([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(Ie`/assistants/${e}`,{...t,headers:Rt([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,s){return this._client.post(Ie`/assistants/${e}`,{body:t,...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e={},t){return this._client.getAPIList("/assistants",de,{query:e,...t,headers:Rt([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}delete(e,t){return this._client.delete(Ie`/assistants/${e}`,{...t,headers:Rt([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class qt extends Se{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:Rt([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class Lt extends Se{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:Rt([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class Nt extends Se{constructor(){super(...arguments),this.sessions=new qt(this._client),this.transcriptionSessions=new Lt(this._client)}}Nt.Sessions=qt,Nt.TranscriptionSessions=Lt;class jt extends Se{create(e,t,s){return this._client.post(Ie`/threads/${e}/messages`,{body:t,...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}retrieve(e,t,s){const{thread_id:n}=t;return this._client.get(Ie`/threads/${n}/messages/${e}`,{...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}update(e,t,s){const{thread_id:n,...r}=t;return this._client.post(Ie`/threads/${n}/messages/${e}`,{body:r,...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e,t={},s){return this._client.getAPIList(Ie`/threads/${e}/messages`,de,{query:t,...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}delete(e,t,s){const{thread_id:n}=t;return this._client.delete(Ie`/threads/${n}/messages/${e}`,{...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}class Ut extends Se{retrieve(e,t,s){const{thread_id:n,run_id:r,...o}=t;return this._client.get(Ie`/threads/${n}/runs/${r}/steps/${e}`,{query:o,...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e,t,s){const{thread_id:n,...r}=t;return this._client.getAPIList(Ie`/threads/${n}/runs/${e}/steps`,de,{query:r,...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}const Bt=e=>void 0!==globalThis.process?globalThis.process.env?.[e]?.trim()??void 0:void 0!==globalThis.Deno?globalThis.Deno.env?.get?.(e)?.trim():void 0;var Wt,Ft,Ht,Jt,Kt,Xt,zt,Gt,Vt,Qt,Zt,Yt,es,ts,ss,ns,rs,os,is,as,ls,cs,us;class ds extends et{constructor(){super(...arguments),Wt.add(this),Ht.set(this,[]),Jt.set(this,{}),Kt.set(this,{}),Xt.set(this,void 0),zt.set(this,void 0),Gt.set(this,void 0),Vt.set(this,void 0),Qt.set(this,void 0),Zt.set(this,void 0),Yt.set(this,void 0),es.set(this,void 0),ts.set(this,void 0)}[(Ht=new WeakMap,Jt=new WeakMap,Kt=new WeakMap,Xt=new WeakMap,zt=new WeakMap,Gt=new WeakMap,Vt=new WeakMap,Qt=new WeakMap,Zt=new WeakMap,Yt=new WeakMap,es=new WeakMap,ts=new WeakMap,Wt=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let s=!1;return this.on("event",s=>{const n=t.shift();n?n.resolve(s):e.push(s)}),this.on("end",()=>{s=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{s=!0;for(const s of t)s.reject(e);t.length=0}),this.on("error",e=>{s=!0;for(const s of t)s.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((e,s)=>t.push({resolve:e,reject:s})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new Ft;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){const s=t?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),this._connected();const n=ne.fromReadableStream(e,this.controller);for await(const e of n)o(this,Wt,"m",ss).call(this,e);if(n.controller.signal?.aborted)throw new Re.cH;return this._addRun(o(this,Wt,"m",ns).call(this))}toReadableStream(){return new ne(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,s,n){const r=new Ft;return r._run(()=>r._runToolAssistantStream(e,t,s,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createToolAssistantStream(e,t,s,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));const i={...s,stream:!0},a=await e.submitToolOutputs(t,i,{...n,signal:this.controller.signal});this._connected();for await(const e of a)o(this,Wt,"m",ss).call(this,e);if(a.controller.signal?.aborted)throw new Re.cH;return this._addRun(o(this,Wt,"m",ns).call(this))}static createThreadAssistantStream(e,t,s){const n=new Ft;return n._run(()=>n._threadAssistantStream(e,t,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),n}static createAssistantStream(e,t,s,n){const r=new Ft;return r._run(()=>r._runAssistantStream(e,t,s,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),r}currentEvent(){return o(this,Yt,"f")}currentRun(){return o(this,es,"f")}currentMessageSnapshot(){return o(this,Xt,"f")}currentRunStepSnapshot(){return o(this,ts,"f")}async finalRunSteps(){return await this.done(),Object.values(o(this,Jt,"f"))}async finalMessages(){return await this.done(),Object.values(o(this,Kt,"f"))}async finalRun(){if(await this.done(),!o(this,zt,"f"))throw Error("Final run was not received.");return o(this,zt,"f")}async _createThreadAssistantStream(e,t,s){const n=s?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort()));const r={...t,stream:!0},i=await e.createAndRun(r,{...s,signal:this.controller.signal});this._connected();for await(const e of i)o(this,Wt,"m",ss).call(this,e);if(i.controller.signal?.aborted)throw new Re.cH;return this._addRun(o(this,Wt,"m",ns).call(this))}async _createAssistantStream(e,t,s,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));const i={...s,stream:!0},a=await e.create(t,i,{...n,signal:this.controller.signal});this._connected();for await(const e of a)o(this,Wt,"m",ss).call(this,e);if(a.controller.signal?.aborted)throw new Re.cH;return this._addRun(o(this,Wt,"m",ns).call(this))}static accumulateDelta(e,t){for(const[s,n]of Object.entries(t)){if(!e.hasOwnProperty(s)){e[s]=n;continue}let t=e[s];if(null!=t)if("index"!==s&&"type"!==s){if("string"==typeof t&&"string"==typeof n)t+=n;else if("number"==typeof t&&"number"==typeof n)t+=n;else{if(!p(t)||!p(n)){if(Array.isArray(t)&&Array.isArray(n)){if(t.every(e=>"string"==typeof e||"number"==typeof e)){t.push(...n);continue}for(const e of n){if(!p(e))throw new Error(`Expected array delta entry to be an object but got: ${e}`);const s=e.index;if(null==s)throw console.error(e),new Error("Expected array delta entry to have an `index` property");if("number"!=typeof s)throw new Error(`Expected array delta entry \`index\` property to be a number but got ${s}`);const n=t[s];null==n?t.push(e):t[s]=this.accumulateDelta(n,e)}continue}throw Error(`Unhandled record type: ${s}, deltaValue: ${n}, accValue: ${t}`)}t=this.accumulateDelta(t,n)}e[s]=t}else e[s]=n;else e[s]=n}return e}_addRun(e){return e}async _threadAssistantStream(e,t,s){return await this._createThreadAssistantStream(t,e,s)}async _runAssistantStream(e,t,s,n){return await this._createAssistantStream(t,e,s,n)}async _runToolAssistantStream(e,t,s,n){return await this._createToolAssistantStream(t,e,s,n)}}Ft=ds,ss=function(e){if(!this.ended)switch(r(this,Yt,e,"f"),o(this,Wt,"m",is).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":o(this,Wt,"m",us).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":o(this,Wt,"m",os).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":o(this,Wt,"m",rs).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},ns=function(){if(this.ended)throw new Re.vc("stream has ended, this shouldn't happen");if(!o(this,zt,"f"))throw Error("Final run has not been received");return o(this,zt,"f")},rs=function(e){const[t,s]=o(this,Wt,"m",ls).call(this,e,o(this,Xt,"f"));r(this,Xt,t,"f"),o(this,Kt,"f")[t.id]=t;for(const e of s){const s=t.content[e.index];"text"==s?.type&&this._emit("textCreated",s.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const s of e.data.delta.content){if("text"==s.type&&s.text){let e=s.text,n=t.content[s.index];if(!n||"text"!=n.type)throw Error("The snapshot associated with this text delta is not text or missing");this._emit("textDelta",e,n.text)}if(s.index!=o(this,Gt,"f")){if(o(this,Vt,"f"))switch(o(this,Vt,"f").type){case"text":this._emit("textDone",o(this,Vt,"f").text,o(this,Xt,"f"));break;case"image_file":this._emit("imageFileDone",o(this,Vt,"f").image_file,o(this,Xt,"f"))}r(this,Gt,s.index,"f")}r(this,Vt,t.content[s.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==o(this,Gt,"f")){const t=e.data.content[o(this,Gt,"f")];if(t)switch(t.type){case"image_file":this._emit("imageFileDone",t.image_file,o(this,Xt,"f"));break;case"text":this._emit("textDone",t.text,o(this,Xt,"f"))}}o(this,Xt,"f")&&this._emit("messageDone",e.data),r(this,Xt,void 0,"f")}},os=function(e){const t=o(this,Wt,"m",as).call(this,e);switch(r(this,ts,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const s=e.data.delta;if(s.step_details&&"tool_calls"==s.step_details.type&&s.step_details.tool_calls&&"tool_calls"==t.step_details.type)for(const e of s.step_details.tool_calls)e.index==o(this,Qt,"f")?this._emit("toolCallDelta",e,t.step_details.tool_calls[e.index]):(o(this,Zt,"f")&&this._emit("toolCallDone",o(this,Zt,"f")),r(this,Qt,e.index,"f"),r(this,Zt,t.step_details.tool_calls[e.index],"f"),o(this,Zt,"f")&&this._emit("toolCallCreated",o(this,Zt,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":r(this,ts,void 0,"f"),"tool_calls"==e.data.step_details.type&&o(this,Zt,"f")&&(this._emit("toolCallDone",o(this,Zt,"f")),r(this,Zt,void 0,"f")),this._emit("runStepDone",e.data,t)}},is=function(e){o(this,Ht,"f").push(e),this._emit("event",e)},as=function(e){switch(e.event){case"thread.run.step.created":return o(this,Jt,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=o(this,Jt,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let s=e.data;if(s.delta){const n=Ft.accumulateDelta(t,s.delta);o(this,Jt,"f")[e.data.id]=n}return o(this,Jt,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":o(this,Jt,"f")[e.data.id]=e.data}if(o(this,Jt,"f")[e.data.id])return o(this,Jt,"f")[e.data.id];throw new Error("No snapshot available")},ls=function(e,t){let s=[];switch(e.event){case"thread.message.created":return[e.data,s];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let n=e.data;if(n.delta.content)for(const e of n.delta.content)if(e.index in t.content){let s=t.content[e.index];t.content[e.index]=o(this,Wt,"m",cs).call(this,e,s)}else t.content[e.index]=e,s.push(e);return[t,s];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,s];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},cs=function(e,t){return Ft.accumulateDelta(t,e)},us=function(e){switch(r(this,es,e.data,"f"),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.cancelling":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":case"thread.run.incomplete":r(this,zt,e.data,"f"),o(this,Zt,"f")&&(this._emit("toolCallDone",o(this,Zt,"f")),r(this,Zt,void 0,"f"))}};class ps extends Se{constructor(){super(...arguments),this.steps=new Ut(this._client)}create(e,t,s){const{include:n,...r}=t;return this._client.post(Ie`/threads/${e}/runs`,{query:{include:n},body:r,...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers]),stream:t.stream??!1})}retrieve(e,t,s){const{thread_id:n}=t;return this._client.get(Ie`/threads/${n}/runs/${e}`,{...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}update(e,t,s){const{thread_id:n,...r}=t;return this._client.post(Ie`/threads/${n}/runs/${e}`,{body:r,...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e,t={},s){return this._client.getAPIList(Ie`/threads/${e}/runs`,de,{query:t,...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}cancel(e,t,s){const{thread_id:n}=t;return this._client.post(Ie`/threads/${n}/runs/${e}/cancel`,{...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async createAndPoll(e,t,s){const n=await this.create(e,t,s);return await this.poll(n.id,{thread_id:e},s)}createAndStream(e,t,s){return ds.createAssistantStream(e,this._client.beta.threads.runs,t,s)}async poll(e,t,s){const n=Rt([s?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":s?.pollIntervalMs?.toString()??void 0}]);for(;;){const{data:r,response:o}=await this.retrieve(e,t,{...s,headers:{...s?.headers,...n}}).withResponse();switch(r.status){case"queued":case"in_progress":case"cancelling":let e=5e3;if(s?.pollIntervalMs)e=s.pollIntervalMs;else{const t=o.headers.get("openai-poll-after-ms");if(t){const s=parseInt(t);isNaN(s)||(e=s)}}await h(e);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return r}}}stream(e,t,s){return ds.createAssistantStream(e,this._client.beta.threads.runs,t,s)}submitToolOutputs(e,t,s){const{thread_id:n,...r}=t;return this._client.post(Ie`/threads/${n}/runs/${e}/submit_tool_outputs`,{body:r,...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers]),stream:t.stream??!1})}async submitToolOutputsAndPoll(e,t,s){const n=await this.submitToolOutputs(e,t,s);return await this.poll(n.id,t,s)}submitToolOutputsStream(e,t,s){return ds.createToolAssistantStream(e,this._client.beta.threads.runs,t,s)}}ps.Steps=Ut;class hs extends Se{constructor(){super(...arguments),this.runs=new ps(this._client),this.messages=new jt(this._client)}create(e={},t){return this._client.post("/threads",{body:e,...t,headers:Rt([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(Ie`/threads/${e}`,{...t,headers:Rt([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,s){return this._client.post(Ie`/threads/${e}`,{body:t,...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}delete(e,t){return this._client.delete(Ie`/threads/${e}`,{...t,headers:Rt([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:Rt([{"OpenAI-Beta":"assistants=v2"},t?.headers]),stream:e.stream??!1})}async createAndRunPoll(e,t){const s=await this.createAndRun(e,t);return await this.runs.poll(s.id,{thread_id:s.thread_id},t)}createAndRunStream(e,t){return ds.createThreadAssistantStream(e,this._client.beta.threads,t)}}hs.Runs=ps,hs.Messages=jt;class fs extends Se{constructor(){super(...arguments),this.realtime=new Nt(this._client),this.assistants=new Mt(this._client),this.threads=new hs(this._client)}}fs.Realtime=Nt,fs.Assistants=Mt,fs.Threads=hs;class ms extends Se{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class gs extends Se{retrieve(e,t,s){const{container_id:n}=t;return this._client.get(Ie`/containers/${n}/files/${e}/content`,{...s,headers:Rt([{Accept:"application/binary"},s?.headers]),__binaryResponse:!0})}}class _s extends Se{constructor(){super(...arguments),this.content=new gs(this._client)}create(e,t,s){return this._client.post(Ie`/containers/${e}/files`,_e({body:t,...s},this._client))}retrieve(e,t,s){const{container_id:n}=t;return this._client.get(Ie`/containers/${n}/files/${e}`,s)}list(e,t={},s){return this._client.getAPIList(Ie`/containers/${e}/files`,de,{query:t,...s})}delete(e,t,s){const{container_id:n}=t;return this._client.delete(Ie`/containers/${n}/files/${e}`,{...s,headers:Rt([{Accept:"*/*"},s?.headers])})}}_s.Content=gs;class ys extends Se{constructor(){super(...arguments),this.files=new _s(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(Ie`/containers/${e}`,t)}list(e={},t){return this._client.getAPIList("/containers",de,{query:e,...t})}delete(e,t){return this._client.delete(Ie`/containers/${e}`,{...t,headers:Rt([{Accept:"*/*"},t?.headers])})}}ys.Files=_s;class ws extends Se{create(e,t,s){const{include:n,...r}=t;return this._client.post(Ie`/conversations/${e}/items`,{query:{include:n},body:r,...s})}retrieve(e,t,s){const{conversation_id:n,...r}=t;return this._client.get(Ie`/conversations/${n}/items/${e}`,{query:r,...s})}list(e,t={},s){return this._client.getAPIList(Ie`/conversations/${e}/items`,pe,{query:t,...s})}delete(e,t,s){const{conversation_id:n}=t;return this._client.delete(Ie`/conversations/${n}/items/${e}`,s)}}class vs extends Se{constructor(){super(...arguments),this.items=new ws(this._client)}create(e={},t){return this._client.post("/conversations",{body:e,...t})}retrieve(e,t){return this._client.get(Ie`/conversations/${e}`,t)}update(e,t,s){return this._client.post(Ie`/conversations/${e}`,{body:t,...s})}delete(e,t){return this._client.delete(Ie`/conversations/${e}`,t)}}vs.Items=ws;class bs extends Se{create(e,t){const s=!!e.encoding_format;let n=s?e.encoding_format:"base64";s&&Z(this._client).debug("embeddings/user defined encoding_format:",e.encoding_format);const r=this._client.post("/embeddings",{body:{...e,encoding_format:n},...t});return s?r:(Z(this._client).debug("embeddings/decoding base64 embeddings from base64"),r._thenUnwrap(e=>(e&&e.data&&e.data.forEach(e=>{const t=e.embedding;e.embedding=(e=>{if("undefined"!=typeof Buffer){const t=Buffer.from(e,"base64");return Array.from(new Float32Array(t.buffer,t.byteOffset,t.length/Float32Array.BYTES_PER_ELEMENT))}{const t=atob(e),s=t.length,n=new Uint8Array(s);for(let e=0;e<s;e++)n[e]=t.charCodeAt(e);return Array.from(new Float32Array(n.buffer))}})(t)}),e)))}}class xs extends Se{retrieve(e,t,s){const{eval_id:n,run_id:r}=t;return this._client.get(Ie`/evals/${n}/runs/${r}/output_items/${e}`,s)}list(e,t,s){const{eval_id:n,...r}=t;return this._client.getAPIList(Ie`/evals/${n}/runs/${e}/output_items`,de,{query:r,...s})}}class Ss extends Se{constructor(){super(...arguments),this.outputItems=new xs(this._client)}create(e,t,s){return this._client.post(Ie`/evals/${e}/runs`,{body:t,...s})}retrieve(e,t,s){const{eval_id:n}=t;return this._client.get(Ie`/evals/${n}/runs/${e}`,s)}list(e,t={},s){return this._client.getAPIList(Ie`/evals/${e}/runs`,de,{query:t,...s})}delete(e,t,s){const{eval_id:n}=t;return this._client.delete(Ie`/evals/${n}/runs/${e}`,s)}cancel(e,t,s){const{eval_id:n}=t;return this._client.post(Ie`/evals/${n}/runs/${e}`,s)}}Ss.OutputItems=xs;class As extends Se{constructor(){super(...arguments),this.runs=new Ss(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(Ie`/evals/${e}`,t)}update(e,t,s){return this._client.post(Ie`/evals/${e}`,{body:t,...s})}list(e={},t){return this._client.getAPIList("/evals",de,{query:e,...t})}delete(e,t){return this._client.delete(Ie`/evals/${e}`,t)}}As.Runs=Ss;class Ds extends Se{create(e,t){return this._client.post("/files",_e({body:e,...t},this._client))}retrieve(e,t){return this._client.get(Ie`/files/${e}`,t)}list(e={},t){return this._client.getAPIList("/files",de,{query:e,...t})}delete(e,t){return this._client.delete(Ie`/files/${e}`,t)}content(e,t){return this._client.get(Ie`/files/${e}/content`,{...t,headers:Rt([{Accept:"application/binary"},t?.headers]),__binaryResponse:!0})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:s=18e5}={}){const n=new Set(["processed","error","deleted"]),r=Date.now();let o=await this.retrieve(e);for(;!o.status||!n.has(o.status);)if(await h(t),o=await this.retrieve(e),Date.now()-r>s)throw new Re.qA({message:`Giving up on waiting for file ${e} to finish processing after ${s} milliseconds.`});return o}}class ks extends Se{}class Is extends Se{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}}class $s extends Se{constructor(){super(...arguments),this.graders=new Is(this._client)}}$s.Graders=Is;class Rs extends Se{create(e,t,s){return this._client.getAPIList(Ie`/fine_tuning/checkpoints/${e}/permissions`,ue,{body:t,method:"post",...s})}retrieve(e,t={},s){return this._client.get(Ie`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...s})}delete(e,t,s){const{fine_tuned_model_checkpoint:n}=t;return this._client.delete(Ie`/fine_tuning/checkpoints/${n}/permissions/${e}`,s)}}class Os extends Se{constructor(){super(...arguments),this.permissions=new Rs(this._client)}}Os.Permissions=Rs;class Ts extends Se{list(e,t={},s){return this._client.getAPIList(Ie`/fine_tuning/jobs/${e}/checkpoints`,de,{query:t,...s})}}class Es extends Se{constructor(){super(...arguments),this.checkpoints=new Ts(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(Ie`/fine_tuning/jobs/${e}`,t)}list(e={},t){return this._client.getAPIList("/fine_tuning/jobs",de,{query:e,...t})}cancel(e,t){return this._client.post(Ie`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},s){return this._client.getAPIList(Ie`/fine_tuning/jobs/${e}/events`,de,{query:t,...s})}pause(e,t){return this._client.post(Ie`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(Ie`/fine_tuning/jobs/${e}/resume`,t)}}Es.Checkpoints=Ts;class Cs extends Se{constructor(){super(...arguments),this.methods=new ks(this._client),this.jobs=new Es(this._client),this.checkpoints=new Os(this._client),this.alpha=new $s(this._client)}}Cs.Methods=ks,Cs.Jobs=Es,Cs.Checkpoints=Os,Cs.Alpha=$s;class Ps extends Se{}class Ms extends Se{constructor(){super(...arguments),this.graderModels=new Ps(this._client)}}Ms.GraderModels=Ps;class qs extends Se{createVariation(e,t){return this._client.post("/images/variations",_e({body:e,...t},this._client))}edit(e,t){return this._client.post("/images/edits",_e({body:e,...t,stream:e.stream??!1},this._client))}generate(e,t){return this._client.post("/images/generations",{body:e,...t,stream:e.stream??!1})}}class Ls extends Se{retrieve(e,t){return this._client.get(Ie`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",ue,e)}delete(e,t){return this._client.delete(Ie`/models/${e}`,t)}}class Ns extends Se{create(e,t){return this._client.post("/moderations",{body:e,...t})}}class js extends Se{create(e,t){return this._client.post("/realtime/client_secrets",{body:e,...t})}}class Us extends Se{constructor(){super(...arguments),this.clientSecrets=new js(this._client)}}Us.ClientSecrets=js;var Bs,Ws,Fs,Hs,Js,Ks,Xs,zs,Gs,Vs,Qs,Zs,Ys,en,tn,sn=s(839);class nn extends et{constructor(e){super(),Bs.add(this),Ws.set(this,void 0),Fs.set(this,void 0),Hs.set(this,void 0),r(this,Ws,e,"f")}static createResponse(e,t,s){const n=new nn(t);return n._run(()=>n._createOrRetrieveResponse(e,t,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),n}async _createOrRetrieveResponse(e,t,s){const n=s?.signal;let r;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),o(this,Bs,"m",Js).call(this);let i=null;"response_id"in t?(r=await e.responses.retrieve(t.response_id,{stream:!0},{...s,signal:this.controller.signal,stream:!0}),i=t.starting_after??null):r=await e.responses.create({...t,stream:!0},{...s,signal:this.controller.signal}),this._connected();for await(const e of r)o(this,Bs,"m",Ks).call(this,e,i);if(r.controller.signal?.aborted)throw new Re.cH;return o(this,Bs,"m",Xs).call(this)}[(Ws=new WeakMap,Fs=new WeakMap,Hs=new WeakMap,Bs=new WeakSet,Js=function(){this.ended||r(this,Fs,void 0,"f")},Ks=function(e,t){if(this.ended)return;const s=(e,s)=>{(null==t||s.sequence_number>t)&&this._emit(e,s)},n=o(this,Bs,"m",zs).call(this,e);switch(s("event",e),e.type){case"response.output_text.delta":{const t=n.output[e.output_index];if(!t)throw new Re.vc(`missing output at index ${e.output_index}`);if("message"===t.type){const n=t.content[e.content_index];if(!n)throw new Re.vc(`missing content at index ${e.content_index}`);if("output_text"!==n.type)throw new Re.vc(`expected content to be 'output_text', got ${n.type}`);s("response.output_text.delta",{...e,snapshot:n.text})}break}case"response.function_call_arguments.delta":{const t=n.output[e.output_index];if(!t)throw new Re.vc(`missing output at index ${e.output_index}`);"function_call"===t.type&&s("response.function_call_arguments.delta",{...e,snapshot:t.arguments});break}default:s(e.type,e)}},Xs=function(){if(this.ended)throw new Re.vc("stream has ended, this shouldn't happen");const e=o(this,Fs,"f");if(!e)throw new Re.vc("request ended without sending any events");r(this,Fs,void 0,"f");const t=function(e,t){return(0,sn.J4)(e,t)}(e,o(this,Ws,"f"));return r(this,Hs,t,"f"),t},zs=function(e){let t=o(this,Fs,"f");if(!t){if("response.created"!==e.type)throw new Re.vc(`When snapshot hasn't been set yet, expected 'response.created' event, got ${e.type}`);return t=r(this,Fs,e.response,"f"),t}switch(e.type){case"response.output_item.added":t.output.push(e.item);break;case"response.content_part.added":{const s=t.output[e.output_index];if(!s)throw new Re.vc(`missing output at index ${e.output_index}`);const n=s.type,r=e.part;"message"===n&&"reasoning_text"!==r.type?s.content.push(r):"reasoning"===n&&"reasoning_text"===r.type&&(s.content||(s.content=[]),s.content.push(r));break}case"response.output_text.delta":{const s=t.output[e.output_index];if(!s)throw new Re.vc(`missing output at index ${e.output_index}`);if("message"===s.type){const t=s.content[e.content_index];if(!t)throw new Re.vc(`missing content at index ${e.content_index}`);if("output_text"!==t.type)throw new Re.vc(`expected content to be 'output_text', got ${t.type}`);t.text+=e.delta}break}case"response.function_call_arguments.delta":{const s=t.output[e.output_index];if(!s)throw new Re.vc(`missing output at index ${e.output_index}`);"function_call"===s.type&&(s.arguments+=e.delta);break}case"response.reasoning_text.delta":{const s=t.output[e.output_index];if(!s)throw new Re.vc(`missing output at index ${e.output_index}`);if("reasoning"===s.type){const t=s.content?.[e.content_index];if(!t)throw new Re.vc(`missing content at index ${e.content_index}`);if("reasoning_text"!==t.type)throw new Re.vc(`expected content to be 'reasoning_text', got ${t.type}`);t.text+=e.delta}break}case"response.completed":r(this,Fs,e.response,"f")}return t},Symbol.asyncIterator)](){const e=[],t=[];let s=!1;return this.on("event",s=>{const n=t.shift();n?n.resolve(s):e.push(s)}),this.on("end",()=>{s=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{s=!0;for(const s of t)s.reject(e);t.length=0}),this.on("error",e=>{s=!0;for(const s of t)s.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((e,s)=>t.push({resolve:e,reject:s})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=o(this,Hs,"f");if(!e)throw new Re.vc("stream ended without producing a ChatCompletion");return e}}class rn extends Se{list(e,t={},s){return this._client.getAPIList(Ie`/responses/${e}/input_items`,de,{query:t,...s})}}class on extends Se{constructor(){super(...arguments),this.inputItems=new rn(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(e=>("object"in e&&"response"===e.object&&(0,sn.aD)(e),e))}retrieve(e,t={},s){return this._client.get(Ie`/responses/${e}`,{query:t,...s,stream:t?.stream??!1})._thenUnwrap(e=>("object"in e&&"response"===e.object&&(0,sn.aD)(e),e))}delete(e,t){return this._client.delete(Ie`/responses/${e}`,{...t,headers:Rt([{Accept:"*/*"},t?.headers])})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(t=>(0,sn.xp)(t,e))}stream(e,t){return nn.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(Ie`/responses/${e}/cancel`,t)}}on.InputItems=rn;class an extends Se{create(e,t,s){return this._client.post(Ie`/uploads/${e}/parts`,_e({body:t,...s},this._client))}}class ln extends Se{constructor(){super(...arguments),this.parts=new an(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(Ie`/uploads/${e}/cancel`,t)}complete(e,t,s){return this._client.post(Ie`/uploads/${e}/complete`,{body:t,...s})}}ln.Parts=an;class cn extends Se{create(e,t,s){return this._client.post(Ie`/vector_stores/${e}/file_batches`,{body:t,...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}retrieve(e,t,s){const{vector_store_id:n}=t;return this._client.get(Ie`/vector_stores/${n}/file_batches/${e}`,{...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}cancel(e,t,s){const{vector_store_id:n}=t;return this._client.post(Ie`/vector_stores/${n}/file_batches/${e}/cancel`,{...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async createAndPoll(e,t,s){const n=await this.create(e,t);return await this.poll(e,n.id,s)}listFiles(e,t,s){const{vector_store_id:n,...r}=t;return this._client.getAPIList(Ie`/vector_stores/${n}/file_batches/${e}/files`,de,{query:r,...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async poll(e,t,s){const n=Rt([s?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":s?.pollIntervalMs?.toString()??void 0}]);for(;;){const{data:r,response:o}=await this.retrieve(t,{vector_store_id:e},{...s,headers:n}).withResponse();switch(r.status){case"in_progress":let e=5e3;if(s?.pollIntervalMs)e=s.pollIntervalMs;else{const t=o.headers.get("openai-poll-after-ms");if(t){const s=parseInt(t);isNaN(s)||(e=s)}}await h(e);break;case"failed":case"cancelled":case"completed":return r}}}async uploadAndPoll(e,{files:t,fileIds:s=[]},n){if(null==t||0==t.length)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const r=n?.maxConcurrency??5,o=Math.min(r,t.length),i=this._client,a=t.values(),l=[...s],c=Array(o).fill(a).map(async function(e){for(let t of e){const e=await i.files.create({file:t,purpose:"assistants"},n);l.push(e.id)}});return await(async e=>{const t=await Promise.allSettled(e),s=t.filter(e=>"rejected"===e.status);if(s.length){for(const e of s)console.error(e.reason);throw new Error(`${s.length} promise(s) failed - see the above errors`)}const n=[];for(const e of t)"fulfilled"===e.status&&n.push(e.value);return n})(c),await this.createAndPoll(e,{file_ids:l})}}class un extends Se{create(e,t,s){return this._client.post(Ie`/vector_stores/${e}/files`,{body:t,...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}retrieve(e,t,s){const{vector_store_id:n}=t;return this._client.get(Ie`/vector_stores/${n}/files/${e}`,{...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}update(e,t,s){const{vector_store_id:n,...r}=t;return this._client.post(Ie`/vector_stores/${n}/files/${e}`,{body:r,...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e,t={},s){return this._client.getAPIList(Ie`/vector_stores/${e}/files`,de,{query:t,...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}delete(e,t,s){const{vector_store_id:n}=t;return this._client.delete(Ie`/vector_stores/${n}/files/${e}`,{...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async createAndPoll(e,t,s){const n=await this.create(e,t,s);return await this.poll(e,n.id,s)}async poll(e,t,s){const n=Rt([s?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":s?.pollIntervalMs?.toString()??void 0}]);for(;;){const r=await this.retrieve(t,{vector_store_id:e},{...s,headers:n}).withResponse(),o=r.data;switch(o.status){case"in_progress":let e=5e3;if(s?.pollIntervalMs)e=s.pollIntervalMs;else{const t=r.response.headers.get("openai-poll-after-ms");if(t){const s=parseInt(t);isNaN(s)||(e=s)}}await h(e);break;case"failed":case"completed":return o}}}async upload(e,t,s){const n=await this._client.files.create({file:t,purpose:"assistants"},s);return this.create(e,{file_id:n.id},s)}async uploadAndPoll(e,t,s){const n=await this.upload(e,t,s);return await this.poll(e,n.id,s)}content(e,t,s){const{vector_store_id:n}=t;return this._client.getAPIList(Ie`/vector_stores/${n}/files/${e}/content`,ue,{...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}class dn extends Se{constructor(){super(...arguments),this.files=new un(this._client),this.fileBatches=new cn(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:Rt([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(Ie`/vector_stores/${e}`,{...t,headers:Rt([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,s){return this._client.post(Ie`/vector_stores/${e}`,{body:t,...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e={},t){return this._client.getAPIList("/vector_stores",de,{query:e,...t,headers:Rt([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}delete(e,t){return this._client.delete(Ie`/vector_stores/${e}`,{...t,headers:Rt([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}search(e,t,s){return this._client.getAPIList(Ie`/vector_stores/${e}/search`,ue,{body:t,method:"post",...s,headers:Rt([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}dn.Files=un,dn.FileBatches=cn;class pn extends Se{constructor(){super(...arguments),Gs.add(this)}async unwrap(e,t,s=this._client.webhookSecret,n=300){return await this.verifySignature(e,t,s,n),JSON.parse(e)}async verifySignature(e,t,s=this._client.webhookSecret,n=300){if("undefined"==typeof crypto||"function"!=typeof crypto.subtle.importKey||"function"!=typeof crypto.subtle.verify)throw new Error("Webhook signature verification is only supported when the `crypto` global is defined");o(this,Gs,"m",Vs).call(this,s);const r=Rt([t]).values,i=o(this,Gs,"m",Qs).call(this,r,"webhook-signature"),a=o(this,Gs,"m",Qs).call(this,r,"webhook-timestamp"),l=o(this,Gs,"m",Qs).call(this,r,"webhook-id"),c=parseInt(a,10);if(isNaN(c))throw new Re.RA("Invalid webhook timestamp format");const u=Math.floor(Date.now()/1e3);if(u-c>n)throw new Re.RA("Webhook timestamp is too old");if(c>u+n)throw new Re.RA("Webhook timestamp is too new");const d=i.split(" ").map(e=>e.startsWith("v1,")?e.substring(3):e),p=s.startsWith("whsec_")?Buffer.from(s.replace("whsec_",""),"base64"):Buffer.from(s,"utf-8"),h=l?`${l}.${a}.${e}`:`${a}.${e}`,f=await crypto.subtle.importKey("raw",p,{name:"HMAC",hash:"SHA-256"},!1,["verify"]);for(const e of d)try{const t=Buffer.from(e,"base64");if(await crypto.subtle.verify("HMAC",f,t,(new TextEncoder).encode(h)))return}catch{continue}throw new Re.RA("The given webhook signature does not match the expected signature")}}Gs=new WeakSet,Vs=function(e){if("string"!=typeof e||0===e.length)throw new Error("The webhook secret must either be set using the env var, OPENAI_WEBHOOK_SECRET, on the client class, OpenAI({ webhookSecret: '123' }), or passed to this function")},Qs=function(e,t){if(!e)throw new Error("Headers are required");const s=e.get(t);if(null==s)throw new Error(`Missing required header: ${t}`);return s};class hn{constructor({baseURL:e=Bt("OPENAI_BASE_URL"),apiKey:t=Bt("OPENAI_API_KEY"),organization:s=Bt("OPENAI_ORG_ID")??null,project:n=Bt("OPENAI_PROJECT_ID")??null,webhookSecret:o=Bt("OPENAI_WEBHOOK_SECRET")??null,...i}={}){if(Zs.add(this),en.set(this,void 0),this.completions=new ms(this),this.chat=new kt(this),this.embeddings=new bs(this),this.files=new Ds(this),this.images=new qs(this),this.audio=new Ct(this),this.moderations=new Ns(this),this.models=new Ls(this),this.fineTuning=new Cs(this),this.graders=new Ms(this),this.vectorStores=new dn(this),this.webhooks=new pn(this),this.beta=new fs(this),this.batches=new Pt(this),this.uploads=new ln(this),this.responses=new on(this),this.realtime=new Us(this),this.conversations=new vs(this),this.evals=new As(this),this.containers=new ys(this),void 0===t)throw new a.vc("Missing credentials. Please pass an `apiKey`, or set the `OPENAI_API_KEY` environment variable.");const l={apiKey:t,organization:s,project:n,webhookSecret:o,...i,baseURL:e||"https://api.openai.com/v1"};if(!l.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new a.vc("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");this.baseURL=l.baseURL,this.timeout=l.timeout??Ys.DEFAULT_TIMEOUT,this.logger=l.logger??console;const c="warn";this.logLevel=c,this.logLevel=X(l.logLevel,"ClientOptions.logLevel",this)??X(Bt("OPENAI_LOG"),"process.env['OPENAI_LOG']",this)??c,this.fetchOptions=l.fetchOptions,this.maxRetries=l.maxRetries??2,this.fetch=l.fetch??function(){if("undefined"!=typeof fetch)return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new OpenAI({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}(),r(this,en,S,"f"),this._options=l,this.apiKey="string"==typeof t?t:"Missing Key",this.organization=s,this.project=n,this.webhookSecret=o}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,organization:this.organization,project:this.project,webhookSecret:this.webhookSecret,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){}async authHeaders(e){return Rt([{Authorization:`Bearer ${this.apiKey}`}])}stringifyQuery(e){return function(e,t={}){let s=e;const n=function(e=P){if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");const t=e.charset||P.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let s=A;if(void 0!==e.format){if(!I(k,e.format))throw new TypeError("Unknown format option provided.");s=e.format}const n=k[s];let r,o=P.filter;if(("function"==typeof e.filter||c(e.filter))&&(o=e.filter),r=e.arrayFormat&&e.arrayFormat in T?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":P.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const i=void 0===e.allowDots?1==!!e.encodeDotInKeys||P.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:P.addQueryPrefix,allowDots:i,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:P.allowEmptyArrays,arrayFormat:r,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:P.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:void 0===e.delimiter?P.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:P.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:P.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:P.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:P.encodeValuesOnly,filter:o,format:s,formatter:n,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:P.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:P.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:P.strictNullHandling}}(t);let r,o;"function"==typeof n.filter?(o=n.filter,s=o("",s)):c(n.filter)&&(o=n.filter,r=o);const i=[];if("object"!=typeof s||null===s)return"";const a=T[n.arrayFormat],l="comma"===a&&n.commaRoundTrip;r||(r=Object.keys(s)),n.sort&&r.sort(n.sort);const u=new WeakMap;for(let e=0;e<r.length;++e){const t=r[e];n.skipNulls&&null===s[t]||E(i,q(s[t],t,a,l,n.allowEmptyArrays,n.strictNullHandling,n.skipNulls,n.encodeDotInKeys,n.encode?n.encoder:null,n.filter,n.sort,n.allowDots,n.serializeDate,n.format,n.formatter,n.encodeValuesOnly,n.charset,u))}const d=i.join(n.delimiter);let p=!0===n.addQueryPrefix?"?":"";return n.charsetSentinel&&("iso-8859-1"===n.charset?p+="utf8=%26%2310003%3B&":p+="utf8=%E2%9C%93&"),d.length>0?p+d:""}(e,{arrayFormat:"brackets"})}getUserAgent(){return`${this.constructor.name}/JS ${m}`}defaultIdempotencyKey(){return`stainless-node-retry-${i()}`}makeStatusError(e,t,s,n){return a.LG.generate(e,t,s,n)}async _callApiKey(){const e=this._options.apiKey;if("function"!=typeof e)return!1;let t;try{t=await e()}catch(e){if(e instanceof a.vc)throw e;throw new a.vc(`Failed to get token from 'apiKey' function: ${e.message}`,{cause:e})}if("string"!=typeof t||!t)throw new a.vc(`Expected 'apiKey' function argument to return a string but it returned ${t}`);return this.apiKey=t,!0}buildURL(e,t,s){const n=!o(this,Zs,"m",tn).call(this)&&s||this.baseURL,r=(e=>l.test(e))(e)?new URL(e):new URL(n+(n.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),i=this.defaultQuery();return function(e){if(!e)return!0;for(const t in e)return!1;return!0}(i)||(t={...i,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}async prepareOptions(e){await this._callApiKey()}async prepareRequest(e,{url:t,options:s}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,s){return this.request(Promise.resolve(s).then(s=>({method:e,path:t,...s})))}request(e,t=null){return new ae(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,s){const n=await e,r=n.maxRetries??this.maxRetries;null==t&&(t=r),await this.prepareOptions(n);const{req:o,url:i,timeout:l}=await this.buildRequest(n,{retryCount:r-t});await this.prepareRequest(o,{url:i,options:n});const c="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),u=void 0===s?"":`, retryOf: ${s}`,d=Date.now();if(Z(this).debug(`[${c}] sending request`,Y({retryOfRequestLogID:s,method:n.method,url:i,options:n,headers:o.headers})),n.signal?.aborted)throw new a.cH;const p=new AbortController,h=await this.fetchWithTimeout(i,o,l,p).catch(f.r),m=Date.now();if(h instanceof globalThis.Error){const e=`retrying, ${t} attempts remaining`;if(n.signal?.aborted)throw new a.cH;const r=(0,f.z)(h)||/timed? ?out/i.test(String(h)+("cause"in h?String(h.cause):""));if(t)return Z(this).info(`[${c}] connection ${r?"timed out":"failed"} - ${e}`),Z(this).debug(`[${c}] connection ${r?"timed out":"failed"} (${e})`,Y({retryOfRequestLogID:s,url:i,durationMs:m-d,message:h.message})),this.retryRequest(n,t,s??c);if(Z(this).info(`[${c}] connection ${r?"timed out":"failed"} - error; no more retries left`),Z(this).debug(`[${c}] connection ${r?"timed out":"failed"} (error; no more retries left)`,Y({retryOfRequestLogID:s,url:i,durationMs:m-d,message:h.message})),r)throw new a.qA;throw new a.xX({cause:h})}const g=`[${c}${u}${[...h.headers.entries()].filter(([e])=>"x-request-id"===e).map(([e,t])=>", "+e+": "+JSON.stringify(t)).join("")}] ${o.method} ${i} ${h.ok?"succeeded":"failed"} with status ${h.status} in ${m-d}ms`;if(!h.ok){const e=await this.shouldRetry(h);if(t&&e){const e=`retrying, ${t} attempts remaining`;return await async function(e){if(null===e||"object"!=typeof e)return;if(e[Symbol.asyncIterator])return void await(e[Symbol.asyncIterator]().return?.());const t=e.getReader(),s=t.cancel();t.releaseLock(),await s}(h.body),Z(this).info(`${g} - ${e}`),Z(this).debug(`[${c}] response error (${e})`,Y({retryOfRequestLogID:s,url:h.url,status:h.status,headers:h.headers,durationMs:m-d})),this.retryRequest(n,t,s??c,h.headers)}const r=e?"error; no more retries left":"error; not retryable";Z(this).info(`${g} - ${r}`);const o=await h.text().catch(e=>(0,f.r)(e).message),i=(e=>{try{return JSON.parse(e)}catch(e){return}})(o),a=i?void 0:o;throw Z(this).debug(`[${c}] response error (${r})`,Y({retryOfRequestLogID:s,url:h.url,status:h.status,headers:h.headers,message:a,durationMs:Date.now()-d})),this.makeStatusError(h.status,i,a,h.headers)}return Z(this).info(g),Z(this).debug(`[${c}] response start`,Y({retryOfRequestLogID:s,url:h.url,status:h.status,headers:h.headers,durationMs:m-d})),{response:h,options:n,controller:p,requestLogID:c,retryOfRequestLogID:s,startTime:d}}getAPIList(e,t,s){return this.requestAPIList(t,{method:"get",path:e,...s})}requestAPIList(e,t){const s=this.makeRequest(t,null,void 0);return new ce(this,s,e)}async fetchWithTimeout(e,t,s,n){const{signal:r,method:o,...i}=t||{};r&&r.addEventListener("abort",()=>n.abort());const a=setTimeout(()=>n.abort(),s),l=globalThis.ReadableStream&&i.body instanceof globalThis.ReadableStream||"object"==typeof i.body&&null!==i.body&&Symbol.asyncIterator in i.body,c={signal:n.signal,...l?{duplex:"half"}:{},method:"GET",...i};o&&(c.method=o.toUpperCase());try{return await this.fetch.call(void 0,e,c)}finally{clearTimeout(a)}}async shouldRetry(e){const t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||409===e.status||429===e.status||e.status>=500)}async retryRequest(e,t,s,n){let r;const o=n?.get("retry-after-ms");if(o){const e=parseFloat(o);Number.isNaN(e)||(r=e)}const i=n?.get("retry-after");if(i&&!r){const e=parseFloat(i);r=Number.isNaN(e)?Date.parse(i)-Date.now():1e3*e}if(!(r&&0<=r&&r<6e4)){const s=e.maxRetries??this.maxRetries;r=this.calculateDefaultRetryTimeoutMillis(t,s)}return await h(r),this.makeRequest(e,t-1,s)}calculateDefaultRetryTimeoutMillis(e,t){const s=t-e;return Math.min(.5*Math.pow(2,s),8)*(1-.25*Math.random())*1e3}async buildRequest(e,{retryCount:t=0}={}){const s={...e},{method:n,path:r,query:o,defaultBaseURL:i}=s,l=this.buildURL(r,o,i);"timeout"in s&&((e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new a.vc(`${e} must be an integer`);if(t<0)throw new a.vc(`${e} must be a positive integer`)})("timeout",s.timeout),s.timeout=s.timeout??this.timeout;const{bodyHeaders:c,body:u}=this.buildBody({options:s});return{req:{method:n,headers:await this.buildHeaders({options:e,method:n,bodyHeaders:c,retryCount:t}),...s.signal&&{signal:s.signal},...globalThis.ReadableStream&&u instanceof globalThis.ReadableStream&&{duplex:"half"},...u&&{body:u},...this.fetchOptions??{},...s.fetchOptions??{}},url:l,timeout:s.timeout}}async buildHeaders({options:e,method:t,bodyHeaders:s,retryCount:n}){let r={};this.idempotencyHeader&&"get"!==t&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),r[this.idempotencyHeader]=e.idempotencyKey);const o=Rt([r,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(n),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...w??(w=g()),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project},await this.authHeaders(e),this._options.defaultHeaders,s,e.headers]);return this.validateHeaders(o),o.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};const s=Rt([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||"string"==typeof e&&s.values.has("content-type")||globalThis.Blob&&e instanceof globalThis.Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:"object"==typeof e&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&"function"==typeof e.next)?{bodyHeaders:void 0,body:b(e)}:o(this,en,"f").call(this,{body:e,headers:s})}}Ys=hn,en=new WeakMap,Zs=new WeakSet,tn=function(){return"https://api.openai.com/v1"!==this.baseURL},hn.OpenAI=Ys,hn.DEFAULT_TIMEOUT=6e5,hn.OpenAIError=a.vc,hn.APIError=a.LG,hn.APIConnectionError=a.xX,hn.APIConnectionTimeoutError=a.qA,hn.APIUserAbortError=a.cH,hn.NotFoundError=a.m_,hn.ConflictError=a.fK,hn.RateLimitError=a.OE,hn.BadRequestError=a.v7,hn.AuthenticationError=a.v3,hn.InternalServerError=a.PO,hn.PermissionDeniedError=a.Ll,hn.UnprocessableEntityError=a.Is,hn.InvalidWebhookSignatureError=a.RA,hn.toFile=async function(e,t,s){if(he(),(e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&be(e))(e=await e))return e instanceof File?e:fe([await e.arrayBuffer()],e.name);if((e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob)(e)){const n=await e.blob();return t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()),fe(await xe(n),t,s)}const n=await xe(e);if(t||(t=me(e)),!s?.type){const e=n.find(e=>"object"==typeof e&&"type"in e&&e.type);"string"==typeof e&&(s={...s,type:e})}return fe(n,t,s)},hn.Completions=ms,hn.Chat=kt,hn.Embeddings=bs,hn.Files=Ds,hn.Images=qs,hn.Audio=Ct,hn.Moderations=Ns,hn.Models=Ls,hn.FineTuning=Cs,hn.Graders=Ms,hn.VectorStores=dn,hn.Webhooks=pn,hn.Beta=fs,hn.Batches=Pt,hn.Uploads=ln,hn.Responses=on,hn.Realtime=Us,hn.Conversations=vs,hn.Evals=As,hn.Containers=ys,s(5606),new Set(["/completions","/chat/completions","/embeddings","/audio/transcriptions","/audio/translations","/audio/speech","/images/generations","/batches","/images/edits"]);var fn=s(341);let mn,gn,_n,yn="responses";function wn(e){_n=e}function vn(e){yn=e}function bn(e){mn=e}function xn(e){gn=e}const Sn={"User-Agent":"Agents/JavaScript 0.1.9"},An=(0,n.tZ)("openai-agents:openai");var Dn=s(4231);const kn=Dn.z.enum(["in_progress","completed","searching","failed"]).default("failed"),In=Dn.z.enum(["in_progress","completed","searching","failed","incomplete"]).default("failed"),$n=Dn.z.enum(["in_progress","completed","interpreting"]).default("in_progress"),Rn=Dn.z.enum(["in_progress","completed","generating","failed"]).default("failed");function On(e={}){const t={type:"web_search",name:e.name??"web_search",user_location:e.userLocation,filters:e.filters?.allowedDomains?{allowed_domains:e.filters.allowedDomains}:void 0,search_context_size:e.searchContextSize??"medium"};return{type:"hosted_tool",name:e.name??"web_search",providerData:t}}function Tn(e,t={}){const s=Array.isArray(e)?e:[e],n={type:"file_search",name:t.name??"file_search",vector_store_ids:s,max_num_results:t.maxNumResults,include_search_results:t.includeSearchResults,ranking_options:t.rankingOptions,filters:t.filters};return{type:"hosted_tool",name:t.name??"file_search",providerData:n}}function En(e={}){const t={type:"code_interpreter",name:e.name??"code_interpreter",container:e.container??{type:"auto"}};return{type:"hosted_tool",name:e.name??"code_interpreter",providerData:t}}function Cn(e={}){const t={type:"image_generation",name:e.name??"image_generation",background:e.background,input_fidelity:e.inputFidelity,input_image_mask:e.inputImageMask,model:e.model,moderation:e.moderation,output_compression:e.outputCompression,output_format:e.outputFormat,partial_images:e.partialImages,quality:e.quality,size:e.size};return{type:"hosted_tool",name:e.name??"image_generation",providerData:t}}function Pn(e){if(!e||"object"!=typeof e||Array.isArray(e))return e;const t={};for(const[s,n]of Object.entries(e))t[s.replace(/([A-Z])/g,"_$1").toLowerCase()]=Pn(n);return t}const Mn=Dn.z.enum(["file_search","web_search","web_search_preview","computer_use_preview","code_interpreter","image_generation","mcp"]),qn=Dn.z.enum(["auto","required","none"]);function Ln(e){if("function"===e.type)return{tool:{type:"function",name:e.name,description:e.description,parameters:e.parameters,strict:e.strict},include:void 0};if("computer"===e.type)return{tool:{type:"computer_use_preview",environment:e.environment,display_width:e.dimensions[0],display_height:e.dimensions[1]},include:void 0};if("hosted_tool"===e.type){if("web_search"===e.providerData?.type)return{tool:{type:"web_search",user_location:e.providerData.user_location,filters:e.providerData.filters,search_context_size:e.providerData.search_context_size},include:void 0};if("web_search_preview"===e.providerData?.type)return{tool:{type:"web_search_preview",user_location:e.providerData.user_location,search_context_size:e.providerData.search_context_size},include:void 0};if("file_search"===e.providerData?.type)return{tool:{type:"file_search",vector_store_ids:e.providerData.vector_store_ids||("string"==typeof e.providerData.vector_store_id?[e.providerData.vector_store_id]:e.providerData.vector_store_id),max_num_results:e.providerData.max_num_results,ranking_options:e.providerData.ranking_options,filters:e.providerData.filters},include:e.providerData.include_search_results?["file_search_call.results"]:void 0};if("code_interpreter"===e.providerData?.type)return{tool:{type:"code_interpreter",container:e.providerData.container},include:void 0};if("image_generation"===e.providerData?.type)return{tool:{type:"image_generation",background:e.providerData.background,input_fidelity:e.providerData.input_fidelity,input_image_mask:e.providerData.input_image_mask,model:e.providerData.model,moderation:e.providerData.moderation,output_compression:e.providerData.output_compression,output_format:e.providerData.output_format,partial_images:e.providerData.partial_images,quality:e.providerData.quality,size:e.providerData.size},include:void 0};if("mcp"===e.providerData?.type)return{tool:{type:"mcp",server_label:e.providerData.server_label,server_url:e.providerData.server_url,connector_id:e.providerData.connector_id,authorization:e.providerData.authorization,allowed_tools:e.providerData.allowed_tools,headers:e.providerData.headers,require_approval:(t=e.providerData.require_approval,"never"===t||void 0===t?"never":"always"===t?"always":{never:{tool_names:t.never?.tool_names},always:{tool_names:t.always?.tool_names}})},include:void 0};if(e.providerData)return{tool:e.providerData,include:void 0}}var t;throw new Error(`Unsupported tool type: ${JSON.stringify(e)}`)}function Nn(e){return{name:e.toolName,description:e.toolDescription,parameters:e.inputJsonSchema,strict:e.strictJsonSchema,type:"function"}}function jn(e){if("input_text"===e.type)return{type:"input_text",text:e.text,...Pn(e.providerData)};if("input_image"===e.type){const t={type:"input_image",detail:"auto"};return"string"==typeof e.image?t.image_url=e.image:t.file_id=e.image.id,{...t,...Pn(e.providerData)}}if("input_file"===e.type){const t={type:"input_file"};if("string"==typeof e.file)if(e.file.startsWith("data:"))t.file_data=e.file;else{if(!e.file.startsWith("https://"))throw new n.yo("Unsupported string data for file input. If you're trying to pass an uploaded file's ID, use an object with the ID property instead.");t.file_url=e.file}else"id"in e.file?t.file_id=e.file.id:"url"in e.file&&(t.file_url=e.file.url);return{...t,...Pn(e.providerData)}}throw new n.yo(`Unsupported input content type: ${JSON.stringify(e)}`)}function Un(e){if("output_text"===e.type)return{type:"output_text",text:e.text,annotations:[],...Pn(e.providerData)};if("refusal"===e.type)return{type:"refusal",refusal:e.refusal,...Pn(e.providerData)};throw new n.yo(`Unsupported output content type: ${JSON.stringify(e)}`)}function Bn(e){return{type:"computer_screenshot",image_url:e.output.data}}function Wn(e){if("output_text"===e.type){const{type:t,text:s,...n}=e;return{type:t,text:s,...n}}if("refusal"===e.type){const{type:t,refusal:s,...n}=e;return{type:t,refusal:s,...n}}throw new Error(`Unsupported message content type: ${JSON.stringify(e)}`)}function Fn(e){return e.map(e=>{if("message"===e.type){const{id:t,type:s,role:n,content:r,status:o,...i}=e;return{id:t,type:s,role:n,content:r.map(Wn),status:o,providerData:i}}if("file_search_call"===e.type||"web_search_call"===e.type||"image_generation_call"===e.type||"code_interpreter_call"===e.type){const{status:t,...s}=e;let n;return"result"in s&&null!==s.result&&(n=s.result,delete s.result),{type:"hosted_tool_call",id:e.id,name:e.type,status:t,output:n,providerData:s}}if("function_call"===e.type){const{call_id:t,name:s,status:n,arguments:r,...o}=e;return{type:"function_call",id:e.id,callId:t,name:s,status:n,arguments:r,providerData:o}}if("computer_call"===e.type){const{call_id:t,status:s,action:n,...r}=e;return{type:"computer_call",id:e.id,callId:t,status:s,action:n,providerData:r}}if("mcp_list_tools"===e.type){const{...t}=e;return{type:"hosted_tool_call",id:e.id,name:e.type,status:"completed",output:void 0,providerData:t}}if("mcp_approval_request"===e.type){const{...t}=e;return{type:"hosted_tool_call",id:e.id,name:"mcp_approval_request",status:"completed",output:void 0,providerData:t}}if("mcp_call"===e.type){const{output:t,...s}=e;return{type:"hosted_tool_call",id:e.id,name:e.type,status:"completed",output:t||void 0,providerData:s}}if("reasoning"===e.type){const{summary:t,...s}=e;return{type:"reasoning",id:e.id,content:t.map(e=>{const{text:t,...s}=e;return{type:"input_text",text:t,providerData:s}}),providerData:s}}return{type:"unknown",providerData:e}})}class Hn{#e;#t;constructor(e,t){this.#e=e,this.#t=t}async#s(e,t){const s=function(e){return"string"==typeof e?[{role:"user",content:e}]:e.map(e=>{if(function(e){return"message"===e.type||void 0===e.type&&"string"==typeof e.role}(e))return function(e){if("system"===e.role)return{id:e.id,role:"system",content:e.content,...Pn(e.providerData)};if("user"===e.role)return"string"==typeof e.content?{id:e.id,role:"user",content:e.content,...Pn(e.providerData)}:{id:e.id,role:"user",content:e.content.map(jn),...Pn(e.providerData)};if("assistant"===e.role)return{type:"message",id:e.id,role:"assistant",content:e.content.map(Un),status:e.status,...Pn(e.providerData)};throw new n.yo(`Unsupported item ${JSON.stringify(e)}`)}(e);if("function_call"===e.type)return{id:e.id,type:"function_call",name:e.name,call_id:e.callId,arguments:e.arguments,status:e.status,...Pn(e.providerData)};if("function_call_result"===e.type){if("text"!==e.output.type)throw new n.yo(`Unsupported tool result type: ${JSON.stringify(e.output)}`);return{type:"function_call_output",id:e.id,call_id:e.callId,output:e.output.text,status:e.status,...Pn(e.providerData)}}if("reasoning"===e.type)return{id:e.id,type:"reasoning",summary:e.content.map(e=>({type:"summary_text",text:e.text,...Pn(e.providerData)})),encrypted_content:e.providerData?.encryptedContent,...Pn(e.providerData)};if("computer_call"===e.type)return{type:"computer_call",call_id:e.callId,id:e.id,action:e.action,status:e.status,pending_safety_checks:[],...Pn(e.providerData)};if("computer_call_result"===e.type)return{type:"computer_call_output",id:e.id,call_id:e.callId,output:Bn(e),status:e.providerData?.status,acknowledged_safety_checks:e.providerData?.acknowledgedSafetyChecks,...Pn(e.providerData)};if("hosted_tool_call"===e.type){if("web_search_call"===e.providerData?.type||"web_search"===e.providerData?.type)return{...Pn(e.providerData),type:"web_search_call",id:e.id,status:kn.parse(e.status??"failed")};if("file_search_call"===e.providerData?.type||"file_search"===e.providerData?.type)return{...Pn(e.providerData),type:"file_search_call",id:e.id,status:In.parse(e.status??"failed"),queries:e.providerData?.queries??[],results:e.providerData?.results};if("code_interpreter_call"===e.providerData?.type||"code_interpreter"===e.providerData?.type)return{...Pn(e.providerData),type:"code_interpreter_call",id:e.id,code:e.providerData?.code??"",outputs:e.providerData?.outputs??e.providerData?.results??[],status:$n.parse(e.status??"failed"),container_id:e.providerData?.container_id};if("image_generation_call"===e.providerData?.type||"image_generation"===e.providerData?.type)return{...Pn(e.providerData),type:"image_generation_call",id:e.id,result:e.providerData?.result??null,status:Rn.parse(e.status??"failed")};if("mcp_list_tools"===e.providerData?.type||"mcp_list_tools"===e.name){const t=e.providerData;return{...Pn(e.providerData),type:"mcp_list_tools",id:e.id,tools:Pn(t.tools),server_label:t.server_label,error:t.error}}if("mcp_approval_request"===e.providerData?.type||"mcp_approval_request"===e.name){const t=e.providerData;return{...Pn(e.providerData),type:"mcp_approval_request",id:t.id??e.id,name:t.name,arguments:t.arguments,server_label:t.server_label}}if("mcp_approval_response"===e.providerData?.type||"mcp_approval_response"===e.name){const t=e.providerData;return{...Pn(t),type:"mcp_approval_response",id:t.id,approve:t.approve,approval_request_id:t.approval_request_id,reason:t.reason}}if("mcp_call"===e.providerData?.type||"mcp_call"===e.name){const t=e.providerData;return{...Pn(t),type:"mcp_call",id:t.id??e.id,name:t.name,arguments:t.arguments,server_label:t.server_label,error:t.error}}throw new n.yo(`Unsupported built-in tool call type: ${JSON.stringify(e)}`)}if("unknown"===e.type)return{...Pn(e.providerData),id:e.id};const t=e;throw new n.yo(`Unsupported item ${JSON.stringify(t)}`)})}(e.input),{tools:r,include:o}=function(e,t){const s=[],n=[];for(const t of e){const{tool:e,include:r}=Ln(t);if(s.push(e),r&&r.length>0)for(const e of r)n.push(e)}return{tools:[...s,...t.map(Nn)],include:n}}(e.tools,e.handoffs),i=function(e){if(void 0===e)return;const t=qn.safeParse(e);if(t.success)return t.data;const s=Mn.safeParse(e);return s.success?{type:s.data}:{type:"function",name:e}}(e.modelSettings.toolChoice),{text:a,...l}=e.modelSettings.providerData??{};e.modelSettings.reasoning&&(l.reasoning={...e.modelSettings.reasoning,...l.reasoning});let c=a;e.modelSettings.text&&(c={...e.modelSettings.text,...a});const u=(p=c,"text"===(d=e.outputType)?p:{...p,format:d});var d,p;const h=function(e){if(!e)return;const t={};for(const[s,n]of Object.entries(e.variables??{}))"string"==typeof n?t[s]=n:"object"==typeof n&&(t[s]=jn(n));return{id:e.promptId,version:e.version,variables:t}}(e.prompt);let f;if("boolean"==typeof e.modelSettings.parallelToolCalls){if(e.modelSettings.parallelToolCalls&&0===r.length)throw new Error("Parallel tool calls are not supported without tools");f=e.modelSettings.parallelToolCalls}const m={model:this.#t,instructions:Jn(e.systemInstructions),input:s,include:o,tools:r,previous_response_id:e.previousResponseId,conversation:e.conversationId,prompt:h,temperature:e.modelSettings.temperature,top_p:e.modelSettings.topP,truncation:e.modelSettings.truncation,max_output_tokens:e.modelSettings.maxTokens,tool_choice:i,parallel_tool_calls:f,stream:t,text:u,store:e.modelSettings.store,...l};An.dontLogModelData?An.debug("Calling LLM"):An.debug(`Calling LLM. Request data: ${JSON.stringify(m,null,2)}`);const g=await this.#e.responses.create(m,{headers:Sn,signal:e.signal});return An.dontLogModelData?An.debug("Response received"):An.debug(`Response received: ${JSON.stringify(g,null,2)}`),g}async getResponse(e){const t=await(0,n.Cp)(async t=>{const s=await this.#s(e,!1);return e.tracing&&(t.spanData.response_id=s.id,t.spanData._input=e.input,t.spanData._response=s),s});return{usage:new n._U({inputTokens:t.usage?.input_tokens??0,outputTokens:t.usage?.output_tokens??0,totalTokens:t.usage?.total_tokens??0,inputTokensDetails:{...t.usage?.input_tokens_details},outputTokensDetails:{...t.usage?.output_tokens_details}}),output:Fn(t.output),responseId:t.id,providerData:t}}async*getStreamedResponse(e){const t=e.tracing?(0,n.UI)():void 0;try{t&&(t.start(),(0,n.mq)(t),!0===e.tracing&&(t.spanData._input=e.input));const s=await this.#s(e,!0);let r;for await(const e of s){if("response.created"===e.type)yield{type:"response_started",providerData:{...e}};else if("response.completed"===e.type){r=e.response;const{response:t,...s}=e,{output:n,usage:o,id:i,...a}=t;yield{type:"response_done",response:{id:i,output:Fn(n),usage:{inputTokens:o?.input_tokens??0,outputTokens:o?.output_tokens??0,totalTokens:o?.total_tokens??0,inputTokensDetails:{...o?.input_tokens_details},outputTokensDetails:{...o?.output_tokens_details}},providerData:a},providerData:s},yield{type:"model",event:e}}else if("response.output_text.delta"===e.type){const{delta:t,...s}=e;yield{type:"output_text_delta",delta:t,providerData:s}}yield{type:"model",event:e}}e.tracing&&t&&r&&(t.spanData.response_id=r.id,t.spanData._response=r)}catch(s){throw t&&t.setError({message:"Error streaming response",data:{error:e.tracing?String(s):s instanceof Error?s.name:void 0}}),s}finally{t&&(t.end(),(0,n.h6)())}}}function Jn(e){if("string"==typeof e){if(""===e.trim())return;return e}}function Kn(e){if(null!=e&&null!=e)return"auto"===e||"required"===e||"none"===e?e:{type:"function",function:{name:e}}}function Xn(e){if("string"==typeof e)return e;const t=[];for(const s of e)if("output_text"===s.type)t.push({type:"text",text:s.text,...s.providerData});else{if("refusal"!==s.type){if("audio"===s.type||"image"===s.type)continue;{const e=s;throw new Error(`Unknown content: ${JSON.stringify(e)}`)}}t.push({type:"refusal",refusal:s.refusal,...s.providerData})}return t}function zn(e){if("string"==typeof e)return e;const t=[];for(const s of e)if("input_text"===s.type)t.push({type:"text",text:s.text,...s.providerData});else if("input_image"===s.type){if("string"!=typeof s.image)throw new Error(`Only image URLs are supported for input_image: ${JSON.stringify(s)}`);const{image_url:e,...n}=s.providerData||{};t.push({type:"image_url",image_url:{url:s.image,...e},...n})}else{if("input_file"===s.type)throw new Error(`File uploads are not supported for chat completions: ${JSON.stringify(s)}`);if("audio"!==s.type){const e=s;throw new Error(`Unknown content: ${JSON.stringify(e)}`)}{const{input_audio:e,...n}=s.providerData||{};t.push({type:"input_audio",input_audio:{data:s.audio,...e},...n})}}return t}function Gn(e){return"message"===e.type||void 0===e.type&&"string"==typeof e.role}function Vn(e){if("function"===e.type)return{type:"function",function:{name:e.name,description:e.description||"",parameters:e.parameters,strict:e.strict}};throw new Error(`Hosted tools are not supported with the ChatCompletions API. Got tool type: ${e.type}, tool: ${JSON.stringify(e)}`)}function Qn(e){return{type:"function",function:{name:e.toolName,description:e.toolDescription||"",parameters:e.inputJsonSchema}}}const Zn="FAKE_ID";class Yn{#e;#t;constructor(e,t){this.#e=e,this.#t=t}async getResponse(e){const t=await(0,n.hn)(async t=>{t.spanData.model=this.#t,t.spanData.model_config=e.modelSettings?{temperature:e.modelSettings.temperature,top_p:e.modelSettings.topP,frequency_penalty:e.modelSettings.frequencyPenalty,presence_penalty:e.modelSettings.presencePenalty,reasoning_effort:e.modelSettings.reasoning?.effort,verbosity:e.modelSettings.text?.verbosity}:{base_url:this.#e.baseURL};const s=await this.#s(e,t,!1);return t&&!0===e.tracing&&(t.spanData.output=[s]),s}),s=[];if(t.choices&&t.choices[0]){const e=t.choices[0].message;if(function(e){return"reasoning"in e&&"string"==typeof e.reasoning&&""!==e.reasoning}(e)&&s.push({type:"reasoning",content:[],rawContent:[{type:"reasoning_text",text:e.reasoning}]}),void 0===e.content||null===e.content||e.tool_calls&&""===e.content){if(e.refusal){const{refusal:n,...r}=e;s.push({id:t.id,type:"message",role:"assistant",content:[{type:"refusal",refusal:n||"",providerData:r}],status:"completed"})}else if(e.audio){const{data:n,...r}=e.audio;s.push({id:t.id,type:"message",role:"assistant",content:[{type:"audio",audio:n,providerData:r}],status:"completed"})}else if(e.tool_calls)for(const n of e.tool_calls)if("function"===n.type){const{id:e,...r}=n,{arguments:o,name:i,...a}=n.function;s.push({id:t.id,type:"function_call",arguments:o,name:i,callId:e,status:"completed",providerData:{...r,...a}})}}else{const{content:n,...r}=e;s.push({id:t.id,type:"message",role:"assistant",content:[{type:"output_text",text:n||"",providerData:r}],status:"completed"})}}var r;return{usage:t.usage?new n._U((r=t.usage,{requests:1,input_tokens:r.prompt_tokens,output_tokens:r.completion_tokens,total_tokens:r.total_tokens,input_tokens_details:{cached_tokens:r.prompt_tokens_details?.cached_tokens||0},output_tokens_details:{reasoning_tokens:r.completion_tokens_details?.reasoning_tokens||0}})):new n._U,output:s,responseId:t.id,providerData:t}}async*getStreamedResponse(e){const t=e.tracing?(0,n.Xq)():void 0;try{t&&(t.start(),(0,n.mq)(t));const s=await this.#s(e,t,!0),r={id:Zn,created:Math.floor(Date.now()/1e3),model:this.#t,object:"chat.completion",choices:[],usage:{prompt_tokens:0,completion_tokens:0,total_tokens:0}};for await(const e of async function*(e,t){let s;const n={started:!1,text_content_index_and_output:null,refusal_content_index_and_output:null,function_calls:{},reasoning:""};for await(const e of t){if(n.started||(n.started=!0,yield{type:"response_started",providerData:{...e}}),yield{type:"model",event:e},s=e.usage||void 0,!e.choices?.[0]?.delta)continue;const t=e.choices[0].delta;if(t.content&&(n.text_content_index_and_output||(n.text_content_index_and_output=[n.refusal_content_index_and_output?1:0,{text:"",type:"output_text",providerData:{annotations:[]}}]),yield{type:"output_text_delta",delta:t.content,providerData:{...e}},n.text_content_index_and_output[1].text+=t.content),"reasoning"in t&&t.reasoning&&"string"==typeof t.reasoning&&(n.reasoning+=t.reasoning),"refusal"in t&&t.refusal&&(n.refusal_content_index_and_output||(n.refusal_content_index_and_output=[n.text_content_index_and_output?1:0,{refusal:"",type:"refusal"}]),n.refusal_content_index_and_output[1].refusal+=t.refusal),t.tool_calls)for(const e of t.tool_calls){e.index in n.function_calls||(n.function_calls[e.index]={id:Zn,arguments:"",name:"",type:"function_call",callId:""});const t=e.function;n.function_calls[e.index].arguments+=t?.arguments||"",n.function_calls[e.index].name+=t?.name||"",n.function_calls[e.index].callId+=e.id||""}}const r=[];if(n.reasoning&&r.push({type:"reasoning",content:[],rawContent:[{type:"reasoning_text",text:n.reasoning}]}),n.text_content_index_and_output||n.refusal_content_index_and_output){const e={id:Zn,content:[],role:"assistant",type:"message",status:"completed"};n.text_content_index_and_output&&e.content.push(n.text_content_index_and_output[1]),n.refusal_content_index_and_output&&e.content.push(n.refusal_content_index_and_output[1]),r.push(e)}for(const e of Object.values(n.function_calls))r.push(e);const o={type:"response_done",response:{id:e.id,usage:{inputTokens:s?.prompt_tokens??0,outputTokens:s?.completion_tokens??0,totalTokens:s?.total_tokens??0,inputTokensDetails:{cached_tokens:s?.prompt_tokens_details?.cached_tokens??0},outputTokensDetails:{reasoning_tokens:s?.completion_tokens_details?.reasoning_tokens??0}},output:r}};yield o}(r,s))yield e;t&&r&&!0===e.tracing&&(t.spanData.output=[r])}catch(s){throw t&&t.setError({message:"Error streaming response",data:{error:!0===e.tracing?String(s):s instanceof Error?s.name:void 0}}),s}finally{t&&(t.end(),(0,n.h6)())}}async#s(e,t,s){const r=[];if(e.tools)for(const t of e.tools)r.push(Vn(t));if(e.handoffs)for(const t of e.handoffs)r.push(Qn(t));const o="text"===(i=e.outputType)?{type:"text"}:"json_schema"===i.type?{type:"json_schema",json_schema:{name:i.name,strict:i.strict,schema:i.schema}}:{type:"json_object"};var i;let a;if("boolean"==typeof e.modelSettings.parallelToolCalls){if(e.modelSettings.parallelToolCalls&&0===r.length)throw new Error("Parallel tool calls are not supported without tools");a=e.modelSettings.parallelToolCalls}const l=function(e){if("string"==typeof e)return[{role:"user",content:e}];const t=[];let s=null;const r=()=>{s&&(s.tool_calls&&0!==s.tool_calls.length||delete s.tool_calls,t.push(s),s=null)},o=()=>(s||(s={role:"assistant",tool_calls:[]}),s);for(const s of e)if(Gn(s)){const{content:e,role:n,providerData:o}=s;if(r(),"assistant"===n){const s={role:"assistant",content:Xn(e),...o};if(Array.isArray(e)){const t=e.find(e=>"audio"===e.type);t&&(s.audio={id:"",...t.providerData})}t.push(s)}else"user"===n?t.push({role:n,content:zn(e),...o}):"system"===n&&t.push({role:"system",content:e,...o})}else{if("reasoning"===s.type){o().reasoning=s.rawContent?.[0]?.text;continue}if("hosted_tool_call"===s.type){if("file_search_call"===s.name){const e=o(),t=e.tool_calls??[],n=s,{function:r,...i}=n.providerData??{},{arguments:a,...l}=r??{};t.push({id:n.id||"",type:"function",function:{name:"file_search_call",arguments:JSON.stringify({queries:n.providerData?.queries??[],status:n.status,...a}),...l},...i}),e.tool_calls=t;continue}throw new n.yo("Hosted tool calls are not supported for chat completions. Got item: "+JSON.stringify(s))}if("computer_call"===s.type||"computer_call_result"===s.type)throw new n.yo("Computer use calls are not supported for chat completions. Got item: "+JSON.stringify(s));if("function_call"===s.type){const e=o(),t=e.tool_calls??[],n=s;t.push({id:n.callId,type:"function",function:{name:n.name,arguments:n.arguments??"{}"}}),e.tool_calls=t}else if("function_call_result"===s.type){r();const e=s;if("text"!==e.output.type)throw new n.yo("Only text output is supported for chat completions. Got item: "+JSON.stringify(s));t.push({role:"tool",tool_call_id:e.callId,content:e.output.text,...e.providerData})}else{if("unknown"!==s.type){const e=s;throw new Error(`Unknown item type: ${JSON.stringify(e)}`)}t.push({...s.providerData})}}return r(),t}(e.input);e.systemInstructions&&l.unshift({content:e.systemInstructions,role:"system"}),t&&!0===e.tracing&&(t.spanData.input=l);const c=e.modelSettings.providerData??{};e.modelSettings.reasoning&&e.modelSettings.reasoning.effort&&(c.reasoning_effort=e.modelSettings.reasoning.effort),e.modelSettings.text&&e.modelSettings.text.verbosity&&(c.verbosity=e.modelSettings.text.verbosity);const u={model:this.#t,messages:l,tools:r.length?r:void 0,temperature:e.modelSettings.temperature,top_p:e.modelSettings.topP,frequency_penalty:e.modelSettings.frequencyPenalty,presence_penalty:e.modelSettings.presencePenalty,max_tokens:e.modelSettings.maxTokens,tool_choice:Kn(e.modelSettings.toolChoice),response_format:o,parallel_tool_calls:a,stream:s,store:e.modelSettings.store,...c};An.dontLogModelData?An.debug("Calling LLM"):An.debug(`Calling LLM. Request data: ${JSON.stringify(u,null,2)}`);const d=await this.#e.chat.completions.create(u,{headers:Sn,signal:e.signal});return An.dontLogModelData?An.debug("Response received"):An.debug(`Response received: ${JSON.stringify(d,null,2)}`),d}}class er{#e;#n;#r;constructor(e={}){if(this.#r=e,this.#r.openAIClient){if(this.#r.apiKey)throw new Error("Cannot provide both apiKey and openAIClient");if(this.#r.baseURL)throw new Error("Cannot provide both baseURL and openAIClient");this.#e=this.#r.openAIClient}this.#n=this.#r.useResponses}#o(){return this.#e||(this.#e=mn??new hn({apiKey:this.#r.apiKey??gn??(0,fn.y)().OPENAI_API_KEY,baseURL:this.#r.baseURL,organization:this.#r.organization,project:this.#r.project})),this.#e}async getModel(e){const t=e||(0,n.fZ)();return this.#n??"responses"===yn?new Hn(this.#o(),t):new Yn(this.#o(),t)}}class tr{#r;constructor(e={}){this.#r={apiKey:e.apiKey??void 0,organization:e.organization??"",project:e.project??"",endpoint:e.endpoint??"https://api.openai.com/v1/traces/ingest",maxRetries:e.maxRetries??3,baseDelay:e.baseDelay??1e3,maxDelay:e.maxDelay??3e4}}async export(e,t){const s=this.#r.apiKey??_n??(0,fn.y)().OPENAI_API_KEY;if(!s)return void An.error("No API key provided for OpenAI tracing exporter. Exports will be skipped");const n={data:e.map(e=>e.toJSON()).filter(e=>!!e)};let r=0,o=this.#r.baseDelay;for(;r<this.#r.maxRetries;){try{const e=await fetch(this.#r.endpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`,"OpenAI-Beta":"traces=v1",...Sn},body:JSON.stringify(n),signal:t});if(e.ok)return void An.debug(`Exported ${n.data.length} items`);if(e.status>=400&&e.status<500)return void An.error(`[non-fatal] Tracing client error ${e.status}: ${await e.text()}`);An.warn(`[non-fatal] Tracing: server error ${e.status}, retrying.`)}catch(e){An.error("[non-fatal] Tracing: request failed: ",e)}if(t?.aborted)return void An.error("Tracing: request aborted");const e=o+.1*Math.random()*o;await new Promise(t=>setTimeout(t,e)),o=Math.min(2*o,this.#r.maxDelay),r++}An.error(`Tracing: failed to export traces after ${this.#r.maxRetries} attempts`)}}function sr(){const e=new tr,t=new n.AF(e);(0,n.JA)([t])}var nr=s(885);(0,n.MJ)(new er),sr()}}]);